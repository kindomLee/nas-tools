<div class="container-xl">
  <!-- Page title -->
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">
          索引器
        </h2>
      </div>
    </div>
  </div>
</div>
<!-- 業務頁面程式碼 -->
<div class="page-body">
  <div class="container-xl">
    <div class="row row-cards">
      <div class="col-12 col-md-4 col-xl-3">
        <a class="card card-link card-link-pop" href="#" data-bs-toggle="modal" data-bs-target="#modal-builtin">
          <div class="card-cover card-cover-blurred text-center" style="background-color: #2E72B9">
            <span class="avatar avatar-xl avatar-thumb avatar-rounded"
                  style="background-image: url(../static/img/indexer.jpg)">
            </span>
          </div>
          <div class="card-body text-center">
            <div class="card-title mb-1">內建索引器</div>
            <div class="text-muted">{% if Config.pt.search_indexer == "builtin" %}<span class="badge bg-green"
                                                                                        title="已開啟"></span>
              正在使用{% endif %}</div>
          </div>
        </a>
      </div>
      <div class="col-12 col-md-4 col-xl-3">
        <a class="card card-link card-link-pop" href="#" data-bs-toggle="modal" data-bs-target="#modal-jackett">
          <div class="card-cover card-cover-blurred text-center bg-black">
            <span class="avatar avatar-xl avatar-thumb avatar-rounded"
                  style="background-image: url(../static/img/jackett.png)">
            </span>
          </div>
          <div class="card-body text-center">
            <div class="card-title mb-1">Jackett</div>
            <div class="text-muted">{% if Config.pt.search_indexer == "jackett" %}<span class="badge bg-green"
                                                                                        title="已開啟"></span>
              正在使用{% endif %}</div>
          </div>
        </a>
      </div>
      <div class="col-12 col-md-4 col-xl-3">
        <a class="card card-link card-link-pop" href="#" data-bs-toggle="modal" data-bs-target="#modal-prowlarr">
          <div class="card-cover card-cover-blurred text-center bg-orange">
            <span class="avatar avatar-xl avatar-thumb avatar-rounded"
                  style="background-image: url(../static/img/prowlarr.png)">
            </span>
          </div>
          <div class="card-body text-center">
            <div class="card-title mb-1">Prowlarr</div>
            <div class="text-muted">{% if Config.pt.search_indexer == "prowlarr" %}<span class="badge bg-green"
                                                                                         title="已開啟"></span>
              正在使用{% endif %}</div>
          </div>
        </a>
      </div>
    </div>
  </div>
</div>
<div class="modal modal-blur fade" id="modal-jackett" tabindex="-1" role="dialog" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Jackett</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">Jackett地址 <span class="form-help"
                                                                   title="Jackett訪問地址和埠，如為https需加https://字首"
                                                                   data-bs-toggle="tooltip">?</span></label>
              <input type="text" value="{% if Config.jackett %}{{ Config.jackett.host or '' }}{% endif %}"
                     id="jackett.host" class="form-control" placeholder="http://127.0.0.1:9117">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">API Key <span class="form-help"
                                                               title="Jackett管理介面右上角複製API Key"
                                                               data-bs-toggle="tooltip">?</span></label>
              <input type="text" value="{% if Config.jackett %}{{ Config.jackett.api_key or '' }}{% endif %}"
                     id="jackett.api_key" class="form-control">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">密碼 <span class="form-help"
                                                            title="Jackett管理介面中配置的Admin password，如未配置可為空"
                                                            data-bs-toggle="tooltip">?</span></label>
              <input type="password" value="{% if Config.jackett %}{{ Config.jackett.password or '' }}{% endif %}"
                     id="jackett.password" class="form-control">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="javascript:test_indexer_config('jackett')" id="jackett_test_btn" class="btn me-auto">
          測試
        </a>
        <a href="javascript:save_indexer_config('jackett')" id="jackett_save_btn" class="btn btn-primary">確定</a>
      </div>
    </div>
  </div>
</div>
<div class="modal modal-blur fade" id="modal-prowlarr" tabindex="-1" role="dialog" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Prowlarr</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-6">
            <div class="mb-3">
              <label class="form-label required">Prowlarr地址 <span class="form-help"
                                                                    title="Prowlarr訪問地址和埠，如為https需加https://字首"
                                                                    data-bs-toggle="tooltip">?</span></label>
              <input type="text" value="{% if Config.prowlarr %}{{ Config.prowlarr.host or '' }}{% endif %}"
                     id="prowlarr.host" class="form-control" placeholder="http://127.0.0.1:9696">
            </div>
          </div>
          <div class="col-lg-6">
            <div class="mb-3">
              <label class="form-label required">API Key <span class="form-help"
                                                               title="在Prowlarr->Settings->General->Security-> API Key中獲取"
                                                               data-bs-toggle="tooltip">?</span></label>
              <input type="text" value="{% if Config.prowlarr %}{{ Config.prowlarr.api_key or '' }}{% endif %}"
                     id="prowlarr.api_key" class="form-control">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="javascript:test_indexer_config('prowlarr')" id="prowlarr_test_btn" class="btn me-auto">
          測試
        </a>
        <a href="javascript:save_indexer_config('prowlarr')" id="prowlarr_save_btn" class="btn btn-primary">確定</a>
      </div>
    </div>
  </div>
</div>
<div class="modal modal-blur fade" id="modal-builtin" tabindex="-1" role="dialog" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">內建索引器</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col">
            <div class="mb-3">
              <label class="form-label required">私有站點 <span class="form-help"
                                                                title="當前可以使用的私有站點清單，內建索引器支援私有站點的先決條件：1、在站點維護中正確配置站點地址和Cookie；2、站點己被支援"
                                                                data-bs-toggle="tooltip">?</span></label>
              <div class="form-selectgroup">
                {% if PrivateCount > 0 %}
                  {% for Indexer in Indexers %}
                    {% if not Indexer.public %}
                      <label class="form-selectgroup-item">
                        <input type="checkbox" name="indexer_site" value="{{ Indexer.id }}"
                               class="form-selectgroup-input"
                               {% if Config.pt.indexer_sites and Indexer.id in Config.pt.indexer_sites %}checked{% endif %}>
                        <span class="form-selectgroup-label">{{ Indexer.name }}</span>
                      </label>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <label class="form-selectgroup-item">
                    <span class="form-selectgroup-label">無</span>
                  </label>
                {% endif %}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">公開站點 <span class="form-help"
                                                       title="當前可用的公開站點，公開站點只要被內建索引器支援了就會在這裡顯示；以下站點因為有Cloudflare防護，需要在站點資訊中維護站點地址、Cookie和User-Agent才能正常使用：EXT.TO；以下站點需要拉取含瀏覽器核心的映象才能正常使用：海盜灣；同時大部分公開站點都需要網路代理才能訪問"
                                                       data-bs-toggle="tooltip">?</span></label>
              <div class="form-selectgroup">
                {% if PublicCount > 0 %}
                  {% for Indexer in Indexers %}
                    {% if Indexer.public %}
                      <label class="form-selectgroup-item">
                        <input type="checkbox" name="indexer_site" value="{{ Indexer.id }}"
                               class="form-selectgroup-input"
                               {% if Config.pt.indexer_sites and Indexer.id in Config.pt.indexer_sites %}checked{% endif %}>
                        <span class="form-selectgroup-label">{{ Indexer.name }}</span>
                      </label>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <label class="form-selectgroup-item">
                    <span class="form-selectgroup-label">無</span>
                  </label>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="javascript:save_indexer_config('builtin')" id="builtin_save_btn" class="btn btn-primary">確定</a>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  // 當前處理的型別
  var currType = "";

  // 儲存配置
  function save_config(type, func, test) {
    currType = type;
    let  params = {"test": test || false};
    if (type !== "builtin") {
      $("#modal-" + type + " input").each(function () {
        let value;
        const key = $(this).attr("id");
        if ($(this).attr("type") === "checkbox") {
          value = !!$(this).prop("checked");
        } else {
          value = $(this).val();
        }
        params[key] = value;
      });
      $("#modal-" + type + " textarea").each(function () {
        const key = $(this).attr("id");
        params[key] = $(this).val();
      });
    } else {
      let sites = [];
      let i = 0;
      $("input[name=indexer_site]").each(function () {
        if ($(this).prop("checked")) {
          sites[i] = $(this).val();
          i = i + 1;
        }
      });
      params['pt.indexer_sites'] = sites
    }
    params['pt.search_indexer'] = type;
    ajax_post("update_config", params, func);
  }

  //儲存配置、關閉和重新整理頁面
  function save_indexer_config(type) {
    $("#modal-" + type).modal('hide');
    save_config(type, function (ret) {
      navmenu('indexer');
    });
  }

  //儲存配置和測試配置
  function test_indexer_config(type) {
    $("#" + type + "_test_btn").text("測試中...");
    save_config(type, function (ret) {
      let command;
      if (currType === "jackett") {
        command = "app.indexer.client.jackett|Jackett";
      } else if (currType === "prowlarr") {
        command = "app.indexer.client.prowlarr|Prowlarr";
      }
      ajax_post("test_connection", {"command": command}, function (ret) {
        if (ret.code === 0) {
          $("#" + currType + "_test_btn").text("測試成功");
        } else {
          $("#" + currType + "_test_btn").text("測試失敗！");
        }
      });
    }, true);
  }
</script>