<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=0">
  <meta name="Robots" content="noindex,nofollow,noarchive">
  <link rel="icon" type="image/png" href="../static/img/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../static/img/logo-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../static/img/logo-16x16.png">
  <link rel="apple-touch-icon" sizes="256x256" href="../static/img/logo-black.png">
  <link rel="shortcut icon" href="../static/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-startup-image" href="../static/img/startup.jpg">
  <link rel="manifest" href="../static/site.webmanifest" crossorigin="use-credentials">
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NAStool">
  <meta name="description" content="NAS媒體庫資源歸集整理自動化工具">
  <meta name="format-detection" content="telephone=no">
  <meta name="referrer" content="never">
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="msapplication-TileColor" content="#1e293b"/>
  <meta name="theme-color" content="#1e293b"/>
  <meta name="HandheldFriendly" content="True"/>
  <meta name="MobileOptimized" content="320"/>
  <title>NAStool - 資源歸集、整理自動化工具</title>
  <!-- CSS files -->
  <link href="../static/css/font-awesome.min.css" rel="stylesheet">
  <link href="../static/css/tabler.min.css" rel="stylesheet"/>
  <link href="../static/css/demo.min.css" rel="stylesheet"/>
  <link href="../static/css/fullcalendar.min.css" rel="stylesheet"/>
  <link href="../static/css/jquery.filetree.css" rel="stylesheet"/>
  <link href="../static/css/dropzone.css" rel="stylesheet"/>
  <!-- 字型 -->
  <style>
      @import url('https://rsms.me/inter/inter.css');

      :root {
          --tblr-font-sans-serif: Inter, -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif;
      }
  </style>
  <!-- 附加樣式 -->
  <style>
      body,
      .page {
          height: 100%;
          overflow: hidden;
      }

      .tooltip-inner {
          text-align: left;
      }

      .fileTree {
          width: 240px;
          max-height: 200px;
          overflow-y: scroll;
          overflow-x: hidden;
          position: absolute;
          display: none;
      }

      .navbar-vertical {
          padding-top: env(safe-area-inset-top) !important;
          position: fixed !important;
          left: 0 !important;
          right: 0 !important;
          top: 0 !important;
      }

      .navbar-expand-md {
          position: fixed !important;
          left: 0 !important;
          right: 0 !important;
          top: 0 !important;
      }

      @media (max-width: 992px) {
          .navbar ul.navbar-nav {
              overflow-y: auto;
              max-height: 80vh;
          }
      }

      .page-wrapper {
          margin-top: calc(env(safe-area-inset-top) + 50px) !important;
          height: 100% !important;
          overflow: scroll !important;
      }

      .offcanvas {
          padding-top: env(safe-area-inset-top) !important;
      }

      .modal-dialog {
          padding-top: env(safe-area-inset-top) !important;
      }
  </style>
  <!-- 站點圖示 -->
  <style>
  {% for site_name, site_icon in SiteFavicons.items() %}
      .siteicon-{{ site_name|hash }} {
          background-image: url(data:image/ico;base64,{{ site_icon }});
          background-size: cover;
          border: 0;
      }
  {% endfor %}
  </style>
</head>

<body>
<div class="page">
  <script src="../static/js/demo-theme.min.js"></script>
  <aside class="navbar navbar-vertical navbar-expand-lg navbar-dark sticky-top">
    <div class="container-xl">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-auto-collapse="true"
              data-bs-target="#navbar-menu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <h1 class="navbar-brand" style="filter:brightness(0) invert(1)">
        <a href="javascript:ScrollToTop()">
          <img src="../static/img/logo-blue.png" height="48" alt="NAStool" class="navbar-brand-image">
        </a>
      </h1>
      <div class="navbar-nav flex-row d-lg-none">
        <div class="nav-item dropdown">
          <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
              <span>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24"
                     viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                     stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                </svg>
              </span>
            <div class="d-none d-xl-block ps-2">
              <div>{{ UserName }}</div>
            </div>
          </a>
          <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
            <a class="dropdown-item hide-theme-dark" href="?theme=dark" role="button">暗黑風格</a>
            <a class="dropdown-item hide-theme-light" href="?theme=light" role="button">明亮風格</a>
            <div class="dropdown-divider"></div>
            {% if "系統設定" in UserPris %}
              <a class="dropdown-item" data-bs-toggle="offcanvas" href="#offcanvasEnd" role="button"
                 aria-controls="offcanvasEnd">訊息中心</a>
              <a class="dropdown-item" href="javascript:show_logging_modal()" role="button">實時日誌</a>
              <div class="dropdown-divider"></div>
              {% if SystemFlag > 0 %}
                <a href="javascript:restart()" class="dropdown-item">重啟</a>
                <a href="javascript:update()" class="dropdown-item">更新</a>
              {% endif %}
            {% endif %}
            <a href="javascript:logout()" class="dropdown-item">登出</a>
          </div>
        </div>
      </div>
      <div class="collapse navbar-collapse" id="navbar-menu">
        <div class="my-2 my-md-0 flex-grow-1 flex-md-grow-0 order-first order-md-last d-lg-none">
          <div class="input-icon">
              <span class="input-icon-addon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                     stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <circle cx="10" cy="10" r="7"/>
                  <line x1="21" y1="21" x2="15" y2="15"/>
                </svg>
              </span>
            <input type="text" value="" class="form-control theme-dark home_search_word" placeholder="搜尋/訂閱...">
          </div>
        </div>
        <ul class="navbar-nav pt-lg-3">
          {% if "我的媒體庫" in UserPris %}
            <li class="nav-item">
              <a class="nav-link" href="javascript:void(0)" onclick="navmenu('index')">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                       stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                       stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <polyline points="5 12 3 12 12 3 21 12 19 12"/>
                    <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"/>
                    <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"/>
                  </svg>
                </span>
                <span class="nav-link-title">
                  開始
                </span>
              </a>
            </li>
          {% endif %}
          {% if "資源搜尋" in UserPris %}
            <li class="nav-item">
              <a class="nav-link" href="javascript:void(0)" onclick="navmenu('search')">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24"
                       height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                       stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <circle cx="10" cy="10" r="7"></circle>
                    <line x1="21" y1="21" x2="15" y2="15"></line>
                  </svg>
                </span>
                <span class="nav-link-title">
                  資源搜尋
                </span>
              </a>
            </li>
          {% endif %}
          {% if "推薦" in UserPris %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false"
                 role="button" aria-expanded="false">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                       stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                       stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path
                            d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z"/>
                  </svg>
                </span>
                <span class="nav-link-title">
                  推薦
                </span>
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=hm')">
                  TMDB熱門電影
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=ht')">
                  TMDB熱門電視劇
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=nm')">
                  TMDB最新電影
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=nt')">
                  TMDB最新電視劇
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=dbom')">
                  正在熱映
                  <span class="badge badge-sm bg-orange text-case ms-2">HOT</span>
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=dbnm')">
                  即將上映
                  <span class="badge badge-sm bg-green text-case ms-2">NEW</span>
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=dbhm')">
                  豆瓣熱門電影
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=dbtop')">
                  豆瓣電影TOP250
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=dbht')">
                  豆瓣熱門電視劇
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=dbdh')">
                  豆瓣熱門動漫
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=dbzy')">
                  豆瓣熱門綜藝
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('recommend?t=bangumi')">
                  Bangumi每日放送
                </a>
              </div>
            </li>
          {% endif %}
          {% if "站點管理" in UserPris %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false"
                 role="button" aria-expanded="false">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-server-2" width="24"
                       height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                       stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <rect x="3" y="4" width="18" height="8" rx="3"></rect>
                    <rect x="3" y="12" width="18" height="8" rx="3"></rect>
                    <line x1="7" y1="8" x2="7" y2="8.01"></line>
                    <line x1="7" y1="16" x2="7" y2="16.01"></line>
                    <path d="M11 8h6"></path>
                    <path d="M11 16h6"></path>
                  </svg>
                </span>
                <span class="nav-link-title">
                  站點管理
                </span>
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('site')">
                  站點維護
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('statistics')">
                  資料統計
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('brushtask')">
                  刷流任務
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('sitelist')">
                  站點資源
                </a>
              </div>
            </li>
          {% endif %}
          {% if "訂閱管理" in UserPris %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false"
                 role="button" aria-expanded="false">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                       stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                       stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <polyline points="9 11 12 14 20 6"/>
                    <path d="M20 12v6a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h9"/>
                  </svg>
                </span>
                <span class="nav-link-title">
                  訂閱管理
                </span>
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('movie_rss')">
                  電影訂閱
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('tv_rss')">
                  電視劇訂閱
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('user_rss')">
                  自定義訂閱
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('rss_calendar')">
                  訂閱日曆
                </a>
              </div>
            </li>
          {% endif %}
          {% if "下載管理" in UserPris %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false"
                 role="button" aria-expanded="false">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="24"
                       height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                       stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                    <polyline points="7 11 12 16 17 11"></polyline>
                    <line x1="12" y1="4" x2="12" y2="16"></line>
                  </svg>
                </span>
                <span class="nav-link-title">
                  下載管理
                </span>
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('downloading')">
                  正在下載
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('downloaded')">
                  近期下載
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('torrent_remove')">
                  自動刪種
                </a>
              </div>
            </li>
          {% endif %}
          {% if "媒體整理" in UserPris %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false"
                 role="button" aria-expanded="false">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-movie" width="24"
                       height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                       stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <rect x="4" y="4" width="16" height="16" rx="2"></rect>
                    <line x1="8" y1="4" x2="8" y2="20"></line>
                    <line x1="16" y1="4" x2="16" y2="20"></line>
                    <line x1="4" y1="8" x2="8" y2="8"></line>
                    <line x1="4" y1="16" x2="8" y2="16"></line>
                    <line x1="4" y1="12" x2="20" y2="12"></line>
                    <line x1="16" y1="8" x2="20" y2="8"></line>
                    <line x1="16" y1="16" x2="20" y2="16"></line>
                  </svg>
                </span>
                <span class="nav-link-title">
                  媒體整理
                </span>
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('mediafile')">
                  檔案管理
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('unidentification')">
                  手動識別
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('history')">
                  歷史記錄
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('tmdbcache')">
                  TMDB快取
                </a>
              </div>
            </li>
          {% endif %}
          {% if "服務" in UserPris %}
            <li class="nav-item">
              <a class="nav-link" href="javascript:void(0)" onclick="navmenu('service')">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                       stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                       stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <rect x="4" y="4" width="6" height="5" rx="2"/>
                    <rect x="4" y="13" width="6" height="7" rx="2"/>
                    <rect x="14" y="4" width="6" height="7" rx="2"/>
                    <rect x="14" y="15" width="6" height="5" rx="2"/>
                  </svg>
                </span>
                <span class="nav-link-title">
                  服務
                </span>
              </a>
            </li>
          {% endif %}
          {% if "系統設定" in UserPris %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false"
                 role="button" aria-expanded="false">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-settings" width="24"
                       height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                       stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path
                            d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z">
                    </path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </span>
                <span class="nav-link-title">
                  設定
                </span>
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('basic')">
                  基礎設定
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('users')">
                  使用者管理
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('library')">
                  媒體庫
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('directorysync')">
                  目錄同步
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('notification')">
                  訊息通知
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('filterrule')">
                  過濾規則
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('customwords')">
                  自定義識別詞
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('indexer')">
                  索引器
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('downloader')">
                  下載器
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('mediaserver')">
                  媒體伺服器
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('subtitle')">
                  字幕
                </a>
                <a class="dropdown-item" href="javascript:void(0)" onclick="navmenu('douban')">
                  豆瓣
                </a>
              </div>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </aside>
  <header class="navbar navbar-expand-md navbar-light d-none d-lg-flex d-print-none sticky-top">
    <div class="container-xl">
      <div class="navbar-nav flex-row order-md-last">
        <div class="nav-item d-none d-md-flex me-3">
          <div class="btn-list">
            <a href="https://github.com/kindomLee/nas-tools" class="btn" target="_blank" rel="noreferrer">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                   stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path
                        d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"/>
              </svg>
              Source code
            </a>
          </div>
        </div>
        <div class="d-none d-md-flex">
          <a href="?theme=dark" class="nav-link px-0 hide-theme-dark" title="暗黑風格" data-bs-placement="bottom">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                 stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"/>
            </svg>
          </a>
          <a href="?theme=light" class="nav-link px-0 hide-theme-light" title="明亮風格" data-bs-placement="bottom">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                 stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <circle cx="12" cy="12" r="4"/>
              <path d="M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7"/>
            </svg>
          </a>
          <div class="nav-item dropdown d-none d-md-flex me-3">
            <a href="#" class="nav-link px-0" data-bs-toggle="dropdown" tabindex="-1" aria-label="新版本提示"
               id="new_version_tip" style="display:none">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                   stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M10 5a2 2 0 0 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6"/>
                <path d="M9 17v1a3 3 0 0 0 6 0v-1"/>
              </svg>
              <span class="badge bg-red"></span>
            </a>
            <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-end dropdown-menu-card">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">新版本</h3>
                </div>
                <div class="list-group list-group-flush list-group-hoverable">
                  <div class="list-group-item">
                    <div class="row align-items-center">
                      <div class="col-auto"><span class="status-dot status-dot-animated bg-red d-block"></span></div>
                      <div class="col text-truncate">
                        <div class="d-block text-muted text-truncate mt-n1" id="new_version_info">
                        </div>
                      </div>
                      {% if SystemFlag > 0 and "系統設定" in UserPris %}
                        <div class="col-auto">
                          <a href="javascript:update(NewVersion)" class="list-group-item-actions" title="升級版本">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="icon icon-tabler icon-tabler-arrow-big-up-lines" width="24" height="24"
                                 viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                 stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path
                                      d="M9 12h-3.586a1 1 0 0 1 -.707 -1.707l6.586 -6.586a1 1 0 0 1 1.414 0l6.586 6.586a1 1 0 0 1 -.707 1.707h-3.586v3h-6v-3z">
                              </path>
                              <path d="M9 21h6"></path>
                              <path d="M9 18h6"></path>
                            </svg>
                          </a>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="nav-item dropdown">
          <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown"
             aria-label="Open user menu">
              <span class="avatar avatar-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24"
                     viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                     stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                </svg>
              </span>
            <div class="d-none d-xl-block ps-2">
              <div>{{ UserName }}</div>
            </div>
          </a>
          <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
            {% if "系統設定" in UserPris %}
              <a class="dropdown-item" data-bs-toggle="offcanvas" href="#offcanvasEnd" role="button"
                 aria-controls="offcanvasEnd">訊息中心</a>
              <a class="dropdown-item" href="javascript:show_logging_modal()" role="button">實時日誌</a>
              <div class="dropdown-divider"></div>
              {% if SystemFlag > 0 %}
                <a href="javascript:restart()" class="dropdown-item">重啟</a>
                <a href="javascript:update()" class="dropdown-item">更新</a>
              {% endif %}
            {% endif %}
            <a href="javascript:logout()" class="dropdown-item">登出</a>
          </div>
        </div>
      </div>
      <div class="collapse navbar-collapse">
        <div>
          <div class="input-icon">
              <span class="input-icon-addon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                     stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <desc>Download more icon variants from https://tabler-icons.io/i/search</desc>
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <circle cx="10" cy="10" r="7"/>
                  <line x1="21" y1="21" x2="15" y2="15"/>
                </svg>
              </span>
            <input type="text" value="" class="form-control home_search_word" placeholder="搜尋/訂閱…"
                   aria-label="資源搜尋/訂閱">
          </div>
        </div>
      </div>
    </div>
  </header>
  <div class="page-wrapper" id="page_wrapper">
    <div id="page_content"></div>
    <footer class="footer footer-transparent d-print-none" style="padding: 0;">
      <div class="container-xl">
        <div class="row text-center align-items-center flex-row-reverse">
          <div class="col-12 col-lg-auto mt-3 mt-lg-0">
            <ul class="list-inline list-inline-dots mb-0">
              <li class="list-inline-item">
                Copyright &copy; 2022
                <a href="." class="link-secondary">NAStool</a>.
                All rights reserved.
              </li>
              <li class="list-inline-item">
                {{ AppVersion }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
  </div>
</div>
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasEnd" aria-labelledby="訊息中心">
  <div class="offcanvas-header">
    <h2 class="offcanvas-title" id="offcanvasEndLabel">訊息中心</h2>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" style="padding:0.5rem 0.5rem;">
    <div class="list-group list-group-flush" id="system-messages">
    </div>
    <div class="mt-3" align="center">
      <button class="btn btn-primary" type="button" data-bs-dismiss="offcanvas">
        關閉
      </button>
    </div>
  </div>
</div>
<!-- 等待框 -->
<div class="modal" id="modal-wait" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-full-width modal-dialog-centered" role="document">
    <div class="spinner-border text-primary m-auto"></div>
  </div>
</div>
<!-- 進度框 -->
<div class="modal modal-blur" id="modal-process" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="card border-0" style="overflow:hidden">
        <div class="progress rounded-0">
          <div class="progress-bar progress-bar-striped progress-bar-animated" id="modal_process_bar"
               style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="card-body text-center">
          <h3 class="card-title strong" id="modal_process_title">
          </h3>
          <small class="text-muted" id="modal_process_text">請稍候...</small>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 危險確認提示框 -->
<div class="modal modal-blur fade" id="system-confirm-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-danger"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-danger icon-lg" width="24" height="24"
             viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
             stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M12 9v2m0 4v.01"/>
          <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75"/>
        </svg>
        <h3>確認</h3>
        <div class="text-muted text-wrap" id="system_confirm_message" style="overflow: hidden">是否確定？</div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col">
              <a href="#" class="btn w-100" data-bs-dismiss="modal">
                取消
              </a>
            </div>
            <div class="col">
              <button class="btn btn-danger w-100" id="system_confirm_btn">
                確定
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 成功帶後續操作提示框 -->
<div class="modal modal-blur fade" id="system-success-action-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-success"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-green icon-lg" width="24" height="24"
             viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
             stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <circle cx="12" cy="12" r="9"/>
          <path d="M9 12l2 2l4 -4"/>
        </svg>
        <h3>成功</h3>
        <div class="text-muted text-wrap" id="system_success_action_message" style="overflow: hidden">操作成功！</div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col">
              <a href="#" class="btn w-100" data-bs-dismiss="modal">
                關閉
              </a>
            </div>
            <div class="col" id="system_success_action_div">
              <button class="btn btn-success w-100" id="system_success_action_btn">
                確定
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 詢問框 -->
<div class="modal modal-blur fade" id="system-ask-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">詢問</div>
        <div id="system_ask_message" class="text-wrap" style="overflow: hidden">是否執行？</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link link-secondary me-auto" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger" id="system_ask_btn">確定</button>
      </div>
    </div>
  </div>
</div>
<!-- 成功提示 -->
<div class="modal modal-blur fade" id="system-success-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-success"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-green icon-lg" width="24" height="24"
             viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
             stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <circle cx="12" cy="12" r="9"/>
          <path d="M9 12l2 2l4 -4"/>
        </svg>
        <h3>成功</h3>
        <div class="text-muted text-wrap" id="system_success_message" style="overflow: hidden">成功！</div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col">
              <a href="javascript:void(0)" id="system_success_modal_btn" class="btn btn-success w-100"
                 data-bs-dismiss="modal">
                確定
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 失敗提示 -->
<div class="modal modal-blur fade" id="system-fail-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-status bg-warning"></div>
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-warning icon-lg" width="24" height="24"
             viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
             stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M12 9v2m0 4v.01"/>
          <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75"/>
        </svg>
        <h3>失敗</h3>
        <div class="text-muted text-wrap" id="system_fail_message" style="overflow:hidden">失敗！</div>
      </div>
      <div class="modal-footer">
        <div class="w-100">
          <div class="row">
            <div class="col">
              <a href="#" id="system_fail_modal_btn" class="btn btn-warning w-100" data-bs-dismiss="modal">
                確定
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 媒體詳情 -->
<div class="modal modal-blur fade" id="system-media-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="card">
        <div class="ribbon ribbon-top ribbon-bookmark bg-purple" id="system_media_vote"></div>
        <div class="row row-0">
          <div class="col-3 d-none d-lg-block">
            <img id="system_media_poster" src="" onerror="this.src='../static/img/no-image.png'"
                 class="w-100 h-100 object-cover">
          </div>
          <div class="col">
            <div class="card-body">
              <h4 class="card-title mb-3">
                <a id="system_media_name_link" href="#" target="_blank"><strong
                        id="system_media_name"></strong></a><br/>
                <span class="text-muted" id="system_release_date"></span>
              </h4>
              <div class="text-muted mb-3" id="system_media_overview">
              </div>
              <div id="system_sites_info"></div>
            </div>
          </div>
        </div>
        <div class="d-flex">
          <a href="#" target="_blank" class="card-btn" id="system_media_url_btn">
            詳情
          </a>
          <a href="javascript:void(0)" data-bs-toggle="dropdown" class="dropdown-toggle card-btn"
             id="system_media_rss_btn">
            訂閱
          </a>
          <div class="dropdown-menu" id="system_media_rss_dropdown"></div>
          <a href="javascript:void(0)" class="card-btn" id="system_media_search_btn"
             style="border-left:1px solid var(--tblr-border-color)">
            搜尋
          </a>
          <a href="javascript:void(0)" class="card-btn" id="system_media_refresh_btn"
             style="border-left:1px solid var(--tblr-border-color)">
            重新整理
          </a>
          <a href="javascript:void(0)" class="card-btn d-none d-md-block" data-bs-dismiss="modal">
            關閉
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 實時日誌 -->
<div class="modal modal-blur fade" id="modal-logging" tabindex="-1" role="dialog" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">實時日誌</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                id="logging_close_head"></button>
      </div>
      <div id="logging_table" class="table-responsive" style="overflow-y: auto; max-height: 60rem;">
      <table class="table table-vcenter card-table table-hover table-striped">
        <thead>
          <tr>
            <th class="w-3">時間</th>
            <th class="w-3">來源</th>
            <th>內容</th>
          </tr>
        </thead>
        <tbody id="logging_content" class="table-tbody">
        </tbody>
      </table>
      </div>
      <div class="modal-footer">
        <a href="javascript:pause_logging()" class="btn btn-link me-auto" id="logging_stop_btn">
          暫停
        </a>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="logging_close_btn">關閉</button>
      </div>
    </div>
  </div>
</div>
<!-- 訂閱季 -->
<div class="modal modal-blur fade" id="system-rss-seasons" tabindex="-1" role="dialog" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">選擇訂閱季</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col">
            <div class="mb-3">
              <div class="form-selectgroup" id="system_rss_seasons_group">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="javascript:void(0)" id="system_rss_seasons_btn" class="btn btn-primary">確定</a>
      </div>
    </div>
  </div>
</div>
<!-- 手動訂閱 -->
<div class="modal modal-blur fade" id="modal-manual-rss" tabindex="-1" role="dialog" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rss_modal_title">新增訂閱</h5>
        <input type="hidden" id="rss_id">
        <input type="hidden" id="rss_type">
        <input type="hidden" id="rss_tmdbid">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-8">
            <div class="mb-3">
              <label class="form-label required">標題</label>
              <input type="text" value="" id="rss_name" class="form-control" placeholder="標題">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">年份</label>
              <input type="text" value="" id="rss_year" class="form-control" placeholder="年份">
            </div>
          </div>
        </div>
        <div class="row" id="rss_tv_season_div">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">季</label>
              <select class="form-select" id="rss_season">
                <option value="" selected>請選擇</option>
              </select>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">總集數 <span class="form-help"
                                                     title="可留空應用TMDB劇集資訊"
                                                     data-bs-toggle="tooltip">?</span></label>
              <input type="text" value="" id="rss_total_ep" class="form-control" placeholder="總集數">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">開始訂閱集數</label>
              <input type="text" value="" id="rss_current_ep" class="form-control" placeholder="開始訂閱集數">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-xl-4">
            <div class="mb-3">
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="fuzzy_match"
                       onclick="javascript:change_match_check(this)">
                <span class="form-check-label">模糊匹配 <span class="form-help"
                                                              title="開啟後不檢查TMDB是否有媒體資訊，只要種子名稱、標題、年份任一匹配關鍵字即會下載，此時標題可以配置正規表示式實現模糊匹配"
                                                              data-bs-toggle="tooltip">?</span></span>
              </label>
            </div>
          </div>
          <div class="col-xl-4">
            <div class="mb-3">
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="over_edition"
                       onclick="javascript:change_over_edition_check(this)">
                <span class="form-check-label">洗版 <span class="form-help"
                                                          title="開啟後RSS不檢查媒體庫是否已存在，命中即會下載"
                                                          data-bs-toggle="tooltip">?</span></span>
              </label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-3">
            <div class="mb-3">
              <label class="form-label">質量</label>
              <select class="form-select" id="rss_restype">
                <option value="" selected>全部</option>
                {% for Restype in RestypeDict %}
                  <option value="{{ Restype }}">{{ Restype }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="mb-3">
              <label class="form-label">解析度</label>
              <select class="form-select" id="rss_pix">
                <option value="" selected>全部</option>
                {% for Pix in PixDict %}
                  <option value="{{ Pix }}">{{ Pix }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="mb-3">
              <label class="form-label">製作組/字幕組</label>
              <input type="text" value="" id="rss_team" class="form-control" placeholder="支援正規表示式">
            </div>
          </div>
          <div class="col-lg-3">
            <div class="mb-3">
              <label class="form-label">過濾規則 <span class="form-help"
                                                       title="質量、解析度與過濾規則為“與”的關係，過濾規則不選擇時將使用站點的過濾規則，站點也未設定過濾規則時將使用預設過濾規則"
                                                       data-bs-toggle="tooltip">?</span></label>
              <select class="form-select" id="rss_rule">
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">下載設定</label>
              <select class="form-select" id="rss_download_setting"
                      onchange="refresh_savepath_select('rss_save_path', true, $(this).val())">
              </select>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="mb-3">
              <label class="form-label">儲存路徑</label>
              <select class="form-select" id="rss_save_path" aria-label="儲存目錄">
              </select>
            </div>
          </div>
        </div>
        <div class="row rss_sites_container" id="rss_sites_div">
          <div class="mb-3">
            <label class="form-label">訂閱站點</label>
            <div class="form-selectgroup" id="rss_sites_group">
            </div>
          </div>
        </div>
        <div class="row rss_sites_container" id="rss_search_sites_div">
          <div class="mb-3">
            <label class="form-label">搜尋站點</label>
            <div class="form-selectgroup" id="rss_search_sites_group">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="javascript:rss_sites_select()" class="btn btn-link me-auto" id="rss_sites_select_btn">
          取消全選
        </a>
        <a href="#" class="btn btn-link text-red" id="rss_delete_btn">
          取消訂閱
        </a>
        <a href="javascript:add_rss_manual()" id="rss_add_btn" class="btn btn-primary">確定</a>
      </div>
    </div>
  </div>
</div>
<!-- 手動識別 -->
<div class="modal modal-blur fade" id="modal-media-identification" tabindex="-1" role="dialog" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rename_header">手動識別</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row" id="rename_path_div">
          <div class="col-lg-9">
            <div class="mb-3">
              <label class="form-label required">路徑</label>
              <input type="text" id="rename_path" class="form-control" readonly>
              <input type="hidden" id="rename_manual_type">
              <input type="hidden" id="unknown_id">
              <input type="hidden" id="transferlog_id" class="form-control">
              <div class="invalid-feedback" id="rename_retmsg"></div>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="mb-3">
              <label class="form-label required">轉移方式</label>
              <select id="rename_syncmod_manual" class="form-select">
                <option value="link" {% if SyncMod=="link" %} selected="selected" {% endif %}>硬連結</option>
                <option value="softlink" {% if SyncMod=="softlink" %} selected="selected" {% endif %}>軟連結</option>
                <option value="copy" {% if SyncMod=="copy" %} selected="selected" {% endif %}>複製</option>
                <option value="move" {% if SyncMod=="move" %} selected="selected" {% endif %}>移動</option>
                <option value="rclonecopy" {% if SyncMod=="rclonecopy" %} selected="selected" {% endif %}>Rclone複製
                </option>
                <option value="rclone" {% if SyncMod=="rclone" %} selected="selected" {% endif %}>Rclone移動</option>
                <option value="miniocopy" {% if SyncMod=="miniocopy" %} selected="selected" {% endif %}>Minio複製
                </option>
                <option value="minio" {% if SyncMod=="minio" %} selected="selected" {% endif %}>Minio移動</option>
              </select>
            </div>
          </div>
        </div>
        <div class="mb-3" id="rename_inpath_div">
          <label class="form-label required">輸入路徑</label>
          <input type="text" id="rename_inpath" class="form-control filetree-folders-only"
                 placeholder="需要轉移的目錄或檔案"
                 autocomplete="off">
          <div class="invalid-feedback" id="rename_udf_retmsg"></div>
        </div>
        <div class="row" id="rename_outpath_div">
          <div class="col-lg-9">
            <div class="mb-3">
              <label class="form-label">輸出路徑</label>
              <input type="text" id="rename_outpath" class="form-control filetree-folders-only"
                     placeholder="轉移後檔案儲存路徑，留空則轉移至媒體庫" autocomplete="off">
            </div>
          </div>
          <div class="col-lg-3">
            <div class="mb-3">
              <label class="form-label required">轉移方式</label>
              <select id="rename_syncmod_customize" class="form-select">
                <option value="link" {% if SyncMod=="link" %} selected="selected" {% endif %}>硬連結</option>
                <option value="softlink" {% if SyncMod=="softlink" %} selected="selected" {% endif %}>軟連結</option>
                <option value="copy" {% if SyncMod=="copy" %} selected="selected" {% endif %}>複製</option>
                <option value="move" {% if SyncMod=="move" %} selected="selected" {% endif %}>移動</option>
                <option value="rclonecopy" {% if SyncMod=="rclonecopy" %} selected="selected" {% endif %}>Rclone複製
                </option>
                <option value="rclone" {% if SyncMod=="rclone" %} selected="selected" {% endif %}>Rclone移動</option>
                <option value="miniocopy" {% if SyncMod=="miniocopy" %} selected="selected" {% endif %}>Minio複製
                </option>
                <option value="minio" {% if SyncMod=="minio" %} selected="selected" {% endif %}>Minio移動</option>
              </select>
            </div>
          </div>
        </div>
        <label class="form-label">型別</label>
        <div class="form-selectgroup-boxes row mb-3">
          <div class="col-lg-4">
            <div class="mb-1">
              <label class="form-selectgroup-item">
                <input type="radio" id="rename_type_mov" name="rename_type" value="MOV" class="form-selectgroup-input"
                       checked>
                <span class="form-selectgroup-label d-flex align-items-center p-3">
                    <span class="me-3">
                      <span class="form-selectgroup-check"></span>
                    </span>
                    <span class="form-selectgroup-label-content">
                      <span class="form-selectgroup-title strong mb-1">電影</span>
                    </span>
                  </span>
              </label>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-1">
              <label class="form-selectgroup-item">
                <input type="radio" id="rename_type_tv" name="rename_type" value="TV" class="form-selectgroup-input">
                <span class="form-selectgroup-label d-flex align-items-center p-3">
                    <span class="me-3">
                      <span class="form-selectgroup-check"></span>
                    </span>
                    <span class="form-selectgroup-label-content">
                      <span class="form-selectgroup-title strong mb-1">電視劇</span>
                    </span>
                  </span>
              </label>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-1">
              <label class="form-selectgroup-item">
                <input type="radio" id="rename_type_anime" name="rename_type" value="ANIME"
                       class="form-selectgroup-input">
                <span class="form-selectgroup-label d-flex align-items-center p-3">
                    <span class="me-3">
                      <span class="form-selectgroup-check"></span>
                    </span>
                    <span class="form-selectgroup-label-content">
                      <span class="form-selectgroup-title strong mb-1">動漫</span>
                    </span>
                  </span>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">TMDB ID</label>
              <input type="text" id="rename_tmdb" class="form-control" placeholder="留空自動識別">
            </div>
          </div>
          <div class="col-lg-4" id="rename_season_div">
            <div class="mb-3">
              <label class="form-label">季</label>
              <select class="form-select" id="rename_season">
                <option value="" selected>請選擇</option>
              </select>
            </div>
          </div>
          <div class="col-lg-4" id="rename_min_filesize_div">
            <div class="mb-3">
              <label class="form-label">最小檔案大小</label>
              <input type="text" id="rename_min_filesize" class="form-control" placeholder="最小檔案大小(MB)">
            </div>
          </div>
          <div class="col-lg-12" id="rename_episode_div">
            <div class="mb-3">
              <label class="form-label">集數定位 <span class="form-help"
                                                       title="3個都不填，用預設識別<br>{ep}: 標定集數位置，例如：<br>&nbsp;&nbsp;&nbsp;&nbsp;(BD)十二國記 第45話「東の海神 西の滄海 五章」(1440x1080 x264-10bpp flac).mkv<br>&nbsp;&nbsp;&nbsp;&nbsp;(BD)十二國記 第32話「風の萬里 黎明の空　九章」(1440x1080 x264-10bpp flac).mkv<br>&nbsp;&nbsp;&nbsp;&nbsp;此處可以填(BD)十二國記 第{ep}話{a}(1440x1080 x264-10bpp flac).mkv ep表示集，a表示理解成一個變數，隨意用一個變數表示，如果沒有變化的部分，只標定ep就行<br>start_ep[, end_ep], 裁定範圍， 如果輸入是檔案，輸出就是單個檔案，如果輸入是目錄，輸出可以根據填的值批次識別<br>&nbsp;&nbsp;&nbsp;&nbsp;例如 '1' 表示第一集, '2,4' 只取第2集到第4集，'1-2'表示第1-2集，此選項優先順序最高<br>offset: 集數偏移, 例如ep定位出集數是11, 實際是第一集, 此處填-10, 以應付多季合集的場景 "
                                                       data-bs-toggle="tooltip" data-bs-html="true">?</span></label>
              <div class="row">
                <div class="col-4">
                  <input type="text" id="rename_episode" class="form-control" placeholder="{ep}.mp4">
                </div>
                <div class="col-4">
                  <input type="text" id="rename_episode_details" class="form-control"
                         placeholder="start_ep[, end_ep] 可選">
                </div>
                <div class="col-4">
                  <input type="text" id="rename_episode_offset" class="form-control" placeholder="offset, 可選">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link me-auto" data-bs-dismiss="modal">取消</button>
        <button type="button" id="identification_action_btn" class="btn btn-primary"
                onclick="manual_media_transfer()">轉移
        </button>
      </div>
    </div>
  </div>
</div>
<!-- 手動下載 -->
<div class="modal modal-blur fade" id="modal-search-download" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered" role="document">
    <input type="hidden" id="search_download_id">
    <input type="hidden" id="search_download_name">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title" id="search_download_message">新增下載</div>
        <div class="row mt-3">
          <div class="col-md">
            <div class="form-floating mb-1">
              <select class="form-select" id="search_download_setting" aria-label="下載設定" onchange="refresh_download_setting_dirs()">
              </select>
              <label for="floatingSelect">下載設定</label>
            </div>
          </div>
          <div class="col-md">
            <div class="form-floating mb-1">
              <select class="form-select" id="search_download_dir" aria-label="儲存目錄">
              </select>
              <label for="floatingSelect">儲存目錄</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link link-secondary me-auto" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="search_download_btn" title="自動選擇目錄下載">
          下載
        </button>
      </div>
    </div>
  </div>
</div>
<script src="../static/js/libs/list.min.js"></script>
<script src="../static/js/jquery-3.3.1.min.js"></script>
<script src="../static/js/tabler.min.js"></script>
<script src="../static/js/demo.min.js"></script>
<script src="../static/js/util.js"></script>
<script src="../static/js/apexcharts.min.js"></script>
<script src="../static/js/echarts.min.js"></script>
<script src="../static/js/numeral.min.js"></script>
<script src="../static/js/fullcalendar.min.js"></script>
<script src="../static/js/locales/zh-cn.js"></script>
<script src="../static/js/jquery.filetree.js"></script>
<script src="../static/js/dropzone-min.js"></script>
<script src="../static/js/dom-to-image.min.js"></script>
<script src="../static/js/FileSaver.min.js"></script>

<!-- 提示彈窗 -->
<script type="text/javascript">
  //顯示全域性載入框
  function show_wait_process(blur) {
    if (blur) {
      $('#modal-wait').addClass('modal-blur');
    } else {
      $('#modal-wait').removeClass('modal-blur');
    }
    $("#modal-wait").modal("show");
  }

  //關閉全域性載入框
  function hide_wait_process() {
    $("#modal-wait").modal("hide");
  }

  //重新整理進度及檔案
  let refresh_process_flag = false;
  let refresh_fail_count = 0;

  function refresh_process() {
    if (!refresh_process_flag) {
      return;
    }
    ajax_post("refresh_process", {type: "search"}, function (ret) {
      if (ret.code === 0 && ret.value <= 100) {
        $("#modal_process_bar").attr("style", "width: " + ret.value + "%").attr("aria-valuenow", ret.value);
        $("#modal_process_text").text(ret.text);
      } else {
        refresh_fail_count = refresh_fail_count + 1;
      }
      if (refresh_fail_count < 5) {
        setTimeout("refresh_process()", 200);
      }
    });
  }

  //顯示全域性進度框
  function show_refresh_process(title) {
    if (title) {
      $("#modal_process_title").text(title);
    } else {
      $("#modal_process_title").hide();
    }
    $("#modal_process_bar").attr("style", "width: 0%").attr("aria-valuenow", 0);
    $("#modal_process_text").text("請稍候...");
    $("#modal-process").modal("show");
    //重新整理進度
    refresh_process_flag = true;
    refresh_fail_count = 0;
    refresh_process();
  }

  //關閉全域性進度框
  function hide_refresh_process() {
    refresh_process_flag = false;
    $("#modal-process").modal("hide");
  }

  //顯示確認提示框
  function show_confirm_modal(title, func) {
    $("#system_confirm_message").text(title);
    $("#system_confirm_btn").unbind('click').click(func);
    $("#system-confirm-modal").modal("show");
  }

  //隱藏確認提示框
  function hide_confirm_modal() {
    $("#system-confirm-modal").modal("hide");
  }

  //顯示詢問提示框
  function show_ask_modal(title, func) {
    $("#system_ask_message").text(title);
    $("#system_ask_btn").unbind('click').click(func);
    $("#system-ask-modal").modal("show");
  }

  //隱藏詢問提示框
  function hide_ask_modal() {
    $("#system-ask-modal").modal("hide");
  }

  //顯示成功提示
  function show_success_modal(title, func) {
    $("#system_success_message").text(title);
    if (func) {
      $("#system_success_modal_btn").unbind('click').click(func);
    } else {
      $("#system_success_modal_btn").unbind('click');
    }
    $("#system-success-modal").modal("show");
  }

  //顯示失敗提示
  function show_fail_modal(title, func) {
    $("#system_fail_message").text(title);
    if (func) {
      $("#system_fail_modal_btn").unbind('click').click(func);
    } else {
      $("#system_fail_modal_btn").unbind('click');
    }
    $("#system-fail-modal").modal("show");
  }
</script>

<!-- 媒體彈窗 -->
<script type="text/javascript">
  //顯示媒體詳情
  function show_mediainfo_modal(rtype, name, year, tmdbid, page, rssid) {
    let doubanid;
    show_wait_process();
    if (tmdbid.startsWith("DB:")) {
      doubanid = tmdbid.replace("DB:", "");
      tmdbid = "";
    } else if (isNaN(tmdbid)) {
      doubanid = "";
      tmdbid = "";
    } else {
      doubanid = "";
    }
    if (!page) {
      page = "";
    }
    if (!rssid) {
      rssid = "";
    }
    ajax_post("media_info", {
      "id": tmdbid,
      "title": name,
      "year": year,
      "type": rtype,
      "doubanid": doubanid,
      "page": page,
      "rssid": rssid
    }, function (ret) {
      hide_wait_process();
      if (ret.code === 0) {
        //顯示資訊
        $("#system_media_name").text(ret.title);
        $("#system_release_date").text(ret.release_date)
        if (ret.poster_path) {
          $("#system_media_poster").attr("src", ret.poster_path);
        } else {
          $("#system_media_poster").attr("src", "../static/img/no-image.png");
        }
        if (ret.overview && ret.overview.length > 200) {
          $("#system_media_overview").text(ret.overview.substr(0, 200) + " ...");
        } else {
          $("#system_media_overview").text(ret.overview);
        }
        if (!ret.vote_average || ret.vote_average == "0") {
          $("#system_media_vote").hide();
        } else {
          $("#system_media_vote").text(ret.vote_average).show();
        }
        //訂閱按鈕、搜尋按鈕
        if ($("#system_media_rss_dropdown").hasClass("show")) {
          $("#system_media_rss_btn").dropdown("toggle");
        }
        //先隱藏所有按鈕，有需要再顯示
        $("#system_media_rss_btn").hide();
        $("#system_media_search_btn").hide();
        $("#system_media_refresh_btn").hide();
        $("#system_media_url_btn").hide();
        if (ret.rssid) {
          //取消訂閱按鈕
          $("#system_media_rss_btn").text("取消訂閱")
              .removeAttr("data-bs-toggle")
              .removeClass("dropdown-toggle")
              .attr("href", 'javascript:remove_rss_media("' + ret.title + '","' + ret.year + '","' + ret.type + '","' + ret.rssid + '","' + ret.page + '")')
              .show();
          //搜尋按鈕
          $("#system_media_search_btn").text("搜尋")
              .attr("href", 'javascript:search_mediainfo_media("' + ret.tmdbid + '", "' + ret.doubanid + '", "' + ret.title + '", "' + ret.type_str + '")')
              .show();
          //重新整理和編輯按鈕
          if (ret.page.startsWith("movie_rss") || ret.page.startsWith("tv_rss")) {
            //編輯
            $("#system_media_url_btn").text("編輯")
                .removeAttr("target")
                .attr("href", "javascript:show_edit_rss_media_modal('" + ret.rssid + "', '" + ret.type_str + "')")
                .show();
            //重新整理
            $("#system_media_refresh_btn").text("重新整理")
                .attr("href", 'javascript:refresh_rss_media("' + ret.type + '","' + ret.rssid + '","' + ret.page + '")')
                .show();
          } else {
            //詳情按鈕
            $("#system_media_url_btn").text("詳情")
                .attr("target", "_blank")
                .attr("href", ret.link_url)
                .show();
          }
        } else {
          //詳情按鈕
          $("#system_media_url_btn").text("詳情")
              .attr("target", "_blank")
              .attr("href", ret.link_url)
              .show();
          //訂閱按鈕
          $("#system_media_rss_btn").text("訂閱");
          $("#system_media_rss_dropdown").empty();
          if (ret.seasons.length === 0) {
            $("#system_media_rss_btn").removeAttr("data-bs-toggle")
                .removeClass("dropdown-toggle")
                .attr("href", 'javascript:add_rss_media("' + ret.title + '","' + ret.year + '","' + ret.type + '","' + ret.tmdbid + '","' + ret.doubanid + '","' + ret.page + '","")')
          } else {
            $("#system_media_rss_btn").prop("data-bs-toggle", "dropdown")
                .addClass("dropdown-toggle")
                .attr("href", 'javascript:$("#system_media_rss_btn").dropdown("toggle")')
            //訂閱季的下拉框
            for (let i = 0; i < ret.seasons.length; i++) {
              $("#system_media_rss_dropdown").append('<a class="dropdown-item" href=\'javascript:add_rss_media("' + ret.title + '","' + ret.year + '","' + ret.type + '","' + ret.tmdbid + '","' + ret.doubanid + '","' + ret.page + '","' + ret.seasons[i].num + '")\'>' + ret.seasons[i].text + '</a>');
            }
          }
          $("#system_media_rss_btn").show();
          //搜尋按鈕
          $("#system_media_search_btn").text("搜尋")
              .attr("href", 'javascript:search_mediainfo_media("' + ret.tmdbid + '", "' + ret.doubanid + '", "' + ret.title + '", "' + ret.type_str + '")')
              .show();
        }
        $("#system_media_name_link").attr("href", ret.link_url);
        //彈窗
        $("#system-media-modal").modal("show");
      } else if (ret.code === 1) {
        if (ret.rssid) {
          show_edit_rss_media_modal(ret.rssid, ret.type_str);
        } else {
          show_fail_modal(`${name} 未查詢到TMDB媒體資訊！`);
        }
      }
    });
  }

  //隱藏媒體詳情
  function hide_mediainfo_modal() {
    $("#system-media-modal").modal("hide");
  }

  //新增訂閱
  function add_rss_media(name, year, type, tmdbid, doubanid, page, season, func) {
    hide_mediainfo_modal();
    let data = {
      "name": name,
      "type": type,
      "year": year,
      "doubanid": doubanid,
      "tmdbid": tmdbid,
      "page": page,
      "season": season
    };
    show_wait_process();
    ajax_post("add_rss_media", data, function (ret) {
      hide_wait_process();
      if (ret.code === 0) {
        if (ret.page) {
          navmenu(ret.page);
        } else {
          if (func) {
            func();
          }
          show_rss_success_modal(ret.rssid, type, name + " 新增訂閱成功！")
        }
      } else {
        show_fail_modal(`${ret.name} 新增訂閱失敗：${ret.msg}！`);
      }
    });
  }

  // 取消訂閱
  function remove_rss_media(name, year, type, rssid, page, tmdbid, func) {
    hide_mediainfo_modal();
    let data = {"name": name, "type": type, "year": year, "rssid": rssid, "page": page, "tmdbid": tmdbid};
    ajax_post("remove_rss_media", data, function (ret) {
      if (func) {
        func();
      } else if (ret.page) {
        navmenu(ret.page);
      } else {
        show_success_modal(ret.name + " 已從訂閱中移除！");
      }
    });
  }

  // 重新整理訂閱
  function refresh_rss_media(type, rssid, page) {
    hide_mediainfo_modal();
    ajax_post("refresh_rss", {"type": type, "rssid": rssid, "page": page}, function (ret) {
      if (ret.page) {
        navmenu(ret.page);
      } else {

      }
    });
  }

  //顯示訂閱季選擇框
  function show_rss_seasons_modal(name, year, type, tmdbid, doubanid, seasons, func) {
    $("#system_rss_seasons_group").empty();
    for (var i = 0; i < seasons.length; i++) {
      $("#system_rss_seasons_group").append('<label class="form-selectgroup-item"><input type="checkbox" name="system_rss_season" value="' + seasons[i].num + '" class="form-selectgroup-input"><span class="form-selectgroup-label">' + seasons[i].text + '</span></label>');
    }
    $("#system_rss_seasons_btn").unbind('click').click(function () {
      $("#system-rss-seasons").modal('hide');
      let i = 0;
      let rss_seasons = [];
      $("input[name='system_rss_season']").each(function () {
        if ($(this).prop("checked")) {
          rss_seasons[i] = $(this).val();
          i = i + 1;
        }
      });
      if (rss_seasons.length > 0) {
        add_rss_media(name, year, type, tmdbid, doubanid, '', rss_seasons, func);
      }
    });
    $("#system-rss-seasons").modal('show');
  }

  //搜尋
  function search_mediainfo_media(tmdbid, doubanid, title, typestr) {
    hide_mediainfo_modal();
    if (!tmdbid && doubanid) {
      tmdbid = "DB:" + doubanid;
    }
    const param = {"tmdbid": tmdbid, "search_word": title, "media_type": typestr};
    show_refresh_process("正在搜尋 " + title + " ...");
    ajax_post("search", param, function (ret) {
      hide_refresh_process();
      if (ret.code === 0) {
        navmenu('search?s=' + title);
      } else {
        show_fail_modal(ret.msg);
      }
    });
  }

  //新增訂閱
  function add_rss_manual() {
    const mtype = $("#rss_type").val();
    const name = $("#rss_name").val();
    const year = $("#rss_year").val();
    const season = $("#rss_season").val();
    const fuzzy_match = $("#fuzzy_match").prop("checked");
    let doubanid;
    let tmdbid = $("#rss_tmdbid").val();
    const over_edition = $("#over_edition").prop("checked");
    const filter_restype = $("#rss_restype").val();
    const filter_pix = $("#rss_pix").val();
    const filter_team = $("#rss_team").val();
    const filter_rule = $("#rss_rule").val();
    const save_path = $("#rss_save_path").val();
    const download_setting = $("#rss_download_setting").val();
    const total_ep = $("#rss_total_ep").val();
    const current_ep = $("#rss_current_ep").val();
    const rssid = $("#rss_id").val();
    if (!name) {
      $("#rss_name").addClass("is-invalid");
      return;
    } else {
      $("#rss_name").removeClass("is-invalid");
    }
    if (year && isNaN(year)) {
      $("#rss_year").addClass("is-invalid");
      return;
    } else {
      $("#rss_year").removeClass("is-invalid");
    }
    if (!fuzzy_match && !season && (mtype == "TV" || mtype == "電視劇")) {
      $("#rss_season").addClass("is-invalid");
      return;
    } else {
      $("#rss_season").removeClass("is-invalid");
    }
    if (total_ep && isNaN(total_ep)) {
      $("#rss_total_ep").addClass("is-invalid");
      return;
    } else {
      $("#rss_total_ep").removeClass("is-invalid");
    }
    if (current_ep && isNaN(current_ep)) {
      $("#rss_current_ep").addClass("is-invalid");
      return;
    } else {
      $("#rss_current_ep").removeClass("is-invalid");
    }
    if (tmdbid && tmdbid.startsWith("DB:")) {
      doubanid = tmdbid.replace("DB:", "");
      tmdbid = "";
    } else {
      doubanid = "";
    }
    //訂閱站點
    let rss_sites = [];
    let rss_all = true;
    $("input[name=rss_sites]").each(function () {
      if ($(this).prop("checked")) {
        rss_sites.push($(this).val());
      } else {
        rss_all = false;
      }
    });
    if (rss_all) {
      rss_sites = [];
    }
    //搜尋站點
    let search_sites = [];
    if (!fuzzy_match) {
      let search_all = true;
      $("input[name=search_sites]").each(function () {
        if ($(this).prop("checked")) {
          search_sites.push($(this).val());
        } else {
          search_all = false;
        }
      });
      if (search_all) {
        search_sites = [];
      }
    }
    const data = {
      "type": mtype,
      "name": name,
      "year": year,
      "season": season,
      "fuzzy_match": fuzzy_match,
      "doubanid": doubanid,
      "tmdbid": tmdbid,
      "rss_sites": rss_sites,
      "search_sites": search_sites,
      "over_edition": over_edition,
      "filter_restype": filter_restype,
      "filter_pix": filter_pix,
      "filter_team": filter_team,
      "filter_rule": filter_rule,
      "save_path": save_path,
      "download_setting": download_setting,
      "total_ep": total_ep,
      "current_ep": current_ep,
      "rssid": rssid,
    };
    $("#modal-manual-rss").modal("hide");
    show_wait_process();
    ajax_post("add_rss_media", data, function (ret) {
      hide_wait_process();
      if (ret.code === 0) {
        if (CURRENT_PAGE_URI.startsWith("tv_rss")) {
          navmenu("tv_rss");
        } else if (CURRENT_PAGE_URI.startsWith("movie_rss")) {
          navmenu("movie_rss");
        } else {
          show_rss_success_modal(ret.rssid, type, name + " 新增訂閱成功！")
        }
      } else {
        if (CURRENT_PAGE_URI.startsWith("tv_rss") || CURRENT_PAGE_URI.startsWith("movie_rss")) {
          show_fail_modal(`${ret.name} 訂閱失敗：${ret.msg}！`, function () {
            $("#modal-manual-rss").modal("show");
          });
        } else {
          show_fail_modal(`${ret.name} 訂閱失敗：${ret.msg}！`);
        }
      }
    });
  }

  //初始化下拉框
  $("#rss_season").empty().append('<option value="">請選擇</option>');
  for (let i = 1; i <= 50; i++) {
    $("#rss_season").append('<option value="' + i + '">第' + i + '季</option>');
  }

  //RSS站點批次選擇
  let rss_sites_select_all = true;

  function rss_sites_select() {
    if (rss_sites_select_all) {
      // 取消全選
      $(".rss_sites_container").find("input[type=checkbox]").each(function () {
        $(this).prop("checked", false);
      });
      rss_sites_select_all = false;
      $("#rss_sites_select_btn").text("全選");
    } else {
      //全選
      $(".rss_sites_container").find("input[type=checkbox]").each(function () {
        $(this).prop("checked", true);
      });
      rss_sites_select_all = true;
      $("#rss_sites_select_btn").text("取消全選");
    }
  }

  // 選擇模糊匹配
  function change_match_check(obj) {
    if ($(obj).prop("checked")) {
      $("#rss_search_sites_div").hide();
      $("#over_edition").prop("checked", false);
    } else {
      $("#rss_search_sites_div").show();
    }
  }

  // 選擇洗版
  function change_over_edition_check(obj) {
    if ($(obj).prop("checked")) {
      $("#fuzzy_match").prop("checked", false);
      $("#rss_search_sites_div").show();
    }
  }


  //取消訂閱
  function remove_rss_manual(type, name, year, rssid) {
    $("#modal-manual-rss").modal('hide');
    let page;
    if (CURRENT_PAGE_URI.startsWith("tv_rss")) {
      page = "tv_rss";
    } else if (CURRENT_PAGE_URI.startsWith("movie_rss")) {
      page = "movie_rss";
    } else {
      page = undefined
    }
    remove_rss_media(name, year, type, rssid, page);
  }

  // 顯示新增電視劇訂閱
  function show_add_tvrss_media_modal() {
    // 重新整理下拉框
    refresh_rss_download_setting_dirs();

    // 介面初始化
    $("#rss_id").val("");
    $("#rss_modal_title").text("新增訂閱");
    $("#rss_type").val("TV");
    $("#rss_name").val("").attr("readonly", false);
    $("#rss_year").val("").attr("readonly", false);
    $("#rss_tmdbid").val("");
    $("#rss_season").val("");
    $("#rss_total_ep").val("");
    $("#rss_current_ep").val("");
    $("#fuzzy_match").prop("checked", false);
    $("#over_edition").prop("checked", false);
    $("#rss_restype").val('');
    $("#rss_pix").val('');
    $("#rss_team").val('');
    $("#rss_rule").val('');
    $("#rss_save_path").val('');
    $("#rss_download_setting").val('-1');
    $("#rss_sites_div").show().find("input[type=checkbox]").each(function () {
      $(this).prop("checked", false);
    });
    $("#rss_search_sites_div").show().find("input[type=checkbox]").each(function () {
      $(this).prop("checked", false);
    });
    $("#rss_delete_btn").hide();
    $("#modal-manual-rss").modal('show');
  }

  // 顯示新增電影訂閱
  function show_add_movierss_media_modal() {
    // 重新整理下拉框
    refresh_rss_download_setting_dirs();

    // 介面初始化
    $("#rss_id").val("");
    $("#rss_modal_title").text("新增訂閱");
    $("#rss_type").val("MOV");
    $("#rss_name").val("").attr("readonly", false);
    $("#rss_year").val("").attr("readonly", false);
    $("#rss_tmdbid").val("");
    $("#rss_tv_season_div").hide();
    $("#fuzzy_match").prop("checked", false);
    $("#over_edition").prop("checked", false);
    $("#rss_restype").val('');
    $("#rss_pix").val('');
    $("#rss_team").val('');
    $("#rss_rule").val('');
    $("#rss_save_path").val('');
    $("#rss_download_setting").val('-1');
    $("#rss_sites_div").show().find("input[type=checkbox]").each(function () {
      $(this).prop("checked", false);
    });
    $("#rss_search_sites_div").show().find("input[type=checkbox]").each(function () {
      $(this).prop("checked", false);
    });
    $("#rss_delete_btn").hide();
    $("#modal-manual-rss").modal('show');
  }

  // 顯示編輯訂閱
  function show_edit_rss_media_modal(rssid, type) {
    $("#system-media-modal").modal('hide');
    $("#rss_id").val(rssid);
    $("#rss_type").val(type);
    $("#rss_modal_title").text("編輯訂閱");

    // 重新整理下拉框
    refresh_rss_download_setting_dirs();

    // 獲取訂閱資訊
    show_wait_process();
    ajax_post("rss_detail", {"rssid": rssid, "rsstype": type}, function (ret) {
      hide_wait_process();
      if (ret.code === 0) {
        $("#rss_tmdbid").val(ret.detail.tmdbid);
        $("#rss_name").val(ret.detail.name).attr("readonly", true);
        $("#rss_year").val(ret.detail.year).attr("readonly", true);
        if (type == "MOV" || type == "電影") {
          $("#rss_tv_season_div").hide();
          $("#rss_season").val("");
          $("#rss_total_ep").val("");
          $("#rss_current_ep").val("");
        } else {
          $("#rss_tv_season_div").show();
          if (ret.detail.season) {
            $("#rss_season").val(parseInt(ret.detail.season.replace("S", "")));
          } else {
            $("#rss_season").val("");
          }
          if (ret.detail.total_ep) {
            $("#rss_total_ep").val(ret.detail.total_ep);
          } else {
            $("#rss_total_ep").val("");
          }
          if (ret.detail.current_ep) {
            $("#rss_current_ep").val(ret.detail.current_ep);
          } else {
            $("#rss_current_ep").val("");
          }
        }
        if (!ret.detail.fuzzy_match) {
          $("#fuzz_match").prop("checked", false);
          $("#rss_search_sites_div").show();
        } else {
          $("#fuzzy_match").prop("checked", true);
          $("#rss_search_sites_div").hide();
        }
        if (ret.detail.over_edition) {
          $("#over_edition").prop("checked", true);
        } else {
          $("#over_edition").prop("checked", false);
        }
        $("#rss_restype").val(ret.detail.filter_restype);
        $("#rss_pix").val(ret.detail.filter_pix);
        $("#rss_team").val(ret.detail.filter_team);
        $("#rss_rule").val(ret.detail.filter_rule);
        $("#rss_save_path").val(ret.detail.save_path);
        $("#rss_download_setting").val(ret.detail.download_setting);
        $("#rss_sites_div").find("input[type=checkbox]").each(function () {
          if (ret.detail.rss_sites && (ret.detail.rss_sites.length === 0 || ret.detail.rss_sites.includes($(this).val()))) {
            $(this).prop("checked", true);
          } else {
            $(this).prop("checked", false);
          }
        });
        $("#rss_search_sites_div").find("input[type=checkbox]").each(function () {
          if (ret.detail.search_sites && (ret.detail.search_sites.length === 0 || ret.detail.search_sites.includes($(this).val()))) {
            $(this).prop("checked", true);
          } else {
            $(this).prop("checked", false);
          }
        });
        $("#rss_delete_btn").attr("href",
            `javascript:remove_rss_manual('${ret.detail.type}','${ret.detail.name}','${ret.detail.year}','${rssid}')`)
            .show();
        $("#modal-manual-rss").modal('show');
      }
    });
  }

  // 顯示訂閱成功（帶後續操作）
  function show_rss_success_modal(rssid, type, text) {
    $("#system_success_action_message").text(text);
    if (rssid) {
      $("#system_success_action_btn").text("編輯訂閱")
          .unbind('click').click(function () {
        $("#system-success-action-modal").modal('hide');
        show_edit_rss_media_modal(rssid, type);
      });
      ;
      $("#system_success_action_div").show();
    } else {
      $("#system_success_action_div").hide();
    }
    $("#system-success-action-modal").modal('show');
  }

  // 重新整理規則下拉框
  function refresh_filter_select(obj_id, aync = true) {
    ajax_post("get_filterrules", {}, function (ret) {
      if (ret.code === 0) {
        let rule_select = $("#" + obj_id);
        rule_select.empty();
        rule_select.append(`<option value="">站點規則</option>`);
        for (let i = 0; i < ret.ruleGroups.length; i++) {
          rule_select.append(`<option value="${ret.ruleGroups[i].id}">${ret.ruleGroups[i].name}</option>`);
        }
      }
    }, aync);
  }

  // 重新整理訂閱站點列表
  var RSS_SITES_LENGTH = 0;

  function refresh_rsssites_select(obj_id, aync = true) {
    ajax_post("get_sites", {rss: true, basic: true}, function (ret) {
      if (ret.code === 0) {
        let rsssites_select = $("#" + obj_id);
        rsssites_select.empty();
        RSS_SITES_LENGTH = ret.sites.length;
        if (ret.sites.length > 0) {
          rsssites_select.parent().parent().show();
        } else {
          rsssites_select.parent().parent().hide();
        }
        for (let i = 0; i < ret.sites.length; i++) {
          rsssites_select.append(`
          <label class="form-selectgroup-item">
            <input type="checkbox" name="rss_sites" value="${ret.sites[i].name}" class="form-selectgroup-input">
            <span class="form-selectgroup-label">${ret.sites[i].name}</span>
          </label>
          `);
        }
      }
    }, aync);
  }

  // 重新整理搜尋站點列表
  function refresh_searchsites_select(obj_id, aync = true) {
    ajax_post("get_indexers", {check: true, basic: true}, function (ret) {
      if (ret.code === 0) {
        let searchsites_select = $("#" + obj_id);
        if (ret.indexers.length > 0) {
          searchsites_select.parent().parent().show();
        } else {
          searchsites_select.parent().parent().hide();
        }
        searchsites_select.empty();
        for (let i = 0; i < ret.indexers.length; i++) {
          searchsites_select.append(`
          <label class="form-selectgroup-item">
            <input type="checkbox" name="search_sites" value="${ret.indexers[i].name}" class="form-selectgroup-input">
            <span class="form-selectgroup-label">${ret.indexers[i].name}</span>
          </label>
          `);
        }
      }
    }, aync);
  }

  // 重新整理儲存路徑
  function refresh_savepath_select(obj_id, aync = true, sid = "") {
    ajax_post("get_download_dirs", {sid: sid}, function (ret) {
      if (ret.code === 0) {
        let savepath_select = $("#" + obj_id);
        savepath_select.empty();
        savepath_select.append(`<option value="">自動</option>`);
        for (let i = 0; i < ret.paths.length; i++) {
          savepath_select.append(`<option value="${ret.paths[i]}">${ret.paths[i]}</option>`);
        }
      }
    }, aync);
  }

  // 重新整理下載設定
  function refresh_downloadsetting_select(obj_id, aync = true) {
    ajax_post("get_download_setting", {}, function (ret) {
      if (ret.code === 0) {
        let downloadsetting_select = $("#" + obj_id);
        downloadsetting_select.empty();
        for (let i = 0; i < ret.data.length; i++) {
          downloadsetting_select.append(`<option value="${ret.data[i].id}">${ret.data[i].name}</option>`);
        }
      }
    }, aync);
  }

  // 重新整理訂閱框的下載設定及目錄等選項
  function refresh_rss_download_setting_dirs(){
    show_wait_process();
    refresh_rsssites_select("rss_sites_group", false);
    refresh_searchsites_select("rss_search_sites_group");
    refresh_filter_select("rss_rule");
    refresh_downloadsetting_select("rss_download_setting", false);
    refresh_savepath_select("rss_save_path", true, $("#rss_download_setting").val());
    hide_wait_process();
  }

  // 重新整理下載框的下載設定及目錄選項
  function refresh_search_download_setting_dirs(){
    refresh_downloadsetting_select("search_download_setting", false);
    refresh_savepath_select("search_download_dir", true, $("#search_download_setting").val());
  }

  // 顯示下載提示框
  function show_download_modal(id, name, func) {
    $("#search_download_id").val(id);
    $("#search_download_name").val(name);
    $("#search_download_message").text("下載 " + name);
    // 根據下載設定重新整理下載目錄選項
    refresh_search_download_setting_dirs();
    // 繫結下載按鈕事件
    if (func) {
      $("#search_download_btn").unbind("click").click(func);
    }else{
      $("#search_download_btn").unbind("click").click(download_link);
    }
    $("#modal-search-download").modal('show');
  }

  //點選連結下載
  function download_link() {
    const id = $("#search_download_id").val();
    const name = $("#search_download_name").val();
    const dir = $("#search_download_dir").val();
    const setting = $("#search_download_setting").val();
    $("#modal-search-download").modal('hide');
    ajax_post("download", {"id": id, "dir": dir, "setting": setting}, function (ret) {
      if (ret.retcode === 0) {
        show_success_modal(`${name} 新增下載成功！`);
      } else {
        show_fail_modal(`${name} 新增下載失敗 ${ret.retmsg}！`);
      }
    });
  }

</script>

<!-- 頁面元件 -->
<script type="text/javascript">

  //重新整理tooltip
  function fresh_tooltip() {
    const tooltipTriggerList = Array.prototype.slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    });
  }

  //開啟路徑選擇框
  function openFileBrowser(el, root, filter, on_folders, on_files, close_on_select) {
    if (on_folders === undefined) on_folders = true;
    if (on_files === undefined) on_files = true;
    if (!filter && !on_files) filter = 'HIDE_FILES_FILTER';
    if (!root.trim()) root = "/";
    let p = $(el);
    // Skip is fileTree is already open
    if (p.next().hasClass('fileTree')) return null;
    // create a random id
    const r = Math.floor((Math.random() * 1000) + 1);
    // Add a new span and load fileTree
    p.after("<div id='fileTree" + r + "' class='fileTree card shadow' style='z-index: 99999'></div>");
    const ft = $('#fileTree' + r);
    ft.fileTree({
          script: 'dirlist',
          root: root,
          filter: filter,
          allowBrowsing: true
        },
        function (file) {
          if (on_files) {
            p.val(file);
            p.trigger('change');
            if (close_on_select) {
              ft.slideUp('fast', function () {
                ft.remove();
              });
            }
          }
        },
        function (folder) {
          if (on_folders) {
            p.val(folder);
            p.trigger('change');
            if (close_on_select) {
              $(ft).slideUp('fast', function () {
                $(ft).remove();
              });
            }
          }
        });
    // Format fileTree according to parent position, height and width
    ft.css({'left': p.position().left, 'top': (p.position().top + p.outerHeight()), 'width': (p.parent().width())});
    // close if click elsewhere
    $(document).mouseup(function (e) {
      if (!ft.is(e.target) && ft.has(e.target).length === 0) {
        ft.slideUp('fast', function () {
          $(ft).remove();
        });
      }
    });
    // close if parent changed
    p.bind("keydown", function () {
      ft.slideUp('fast', function () {
        $(ft).remove();
      });
    });
    // Open fileTree
    ft.slideDown('fast');
  }

  //初始化目錄選擇控制元件
  function init_filetree_element() {
    $('.filetree-folders-only').each(function () {
      $(this).attr("onclick", "openFileBrowser(this,$(this).val(),'',true,false);");
    });
    $('.filetree-files-only').each(function () {
      $(this).attr("onclick", "openFileBrowser(this,$(this).val(),'',false,true);");
    });
  }

  //滑鼠提示等待
  function make_cursor_busy() {
    const body = document.querySelector("body");
    body.style.cursor = "wait";
  }

  //滑鼠取消等待
  function cancel_cursor_busy() {
    const body = document.querySelector("body");
    body.style.cursor = "default";
  }

  // 名稱識別測試
  function media_name_test(name, result_div, func) {
    if (!name) {
      return;
    }
    ajax_post("name_test", {"name": name}, function (ret) {
      if (func) {
        func();
      }
      if (ret.code === 0) {
        media_name_test_ui(ret.data, result_div);
      }
    });
  }

  // 處理識別結果UI
  function media_name_test_ui(data, result_div) {
    let content = '';
    let ignored_words = [];
    let replaced_words = [];
    let offset_words = [];
    if (data.ignored_words) {
      ignored_words = data.ignored_words;
    }
    if (data.replaced_words) {
      replaced_words = data.replaced_words;
    }
    if (data.offset_words) {
      offset_words = data.offset_words;
    }
    const words = ignored_words + replaced_words + offset_words;
    if (words.length !== 0) {
      if (data.org_string) {
        content = `${content}<div class="mb-3" ><label class="form-label">識別使用名稱：<span class="badge badge-outline text-wrap text-cyan me-1 mb-1" style="vertical-align: middle;white-space: normal;text-align: left;word-break: break-all;" title="自定義識別詞過濾後識別用名">${data.org_string}</span></label></div>`;
      }
      if (ignored_words.length !== 0) {
        let ignored_word_content = '';
        for (ignored_word of ignored_words) {
          ignored_word_content = `${ignored_word_content}<span class="badge badge-outline text-wrap text-cyan me-1 mb-1" style="vertical-align: middle;">${ignored_word}</span>`;
        }
        content = `${content}<div class="mb-3"><label class="form-label">應用遮蔽詞：${ignored_word_content}</label></div>`;
      }
      if (replaced_words.length !== 0) {
        let replaced_words_content = '';
        for (replaced_word of replaced_words) {
          replaced_words_content = replaced_words_content + `<span class="badge badge-outline text-wrap text-cyan me-1 mb-1" style="vertical-align: middle;">${replaced_word}</span>`;
        }
        content = `${content}<div class="mb-3"><label class="form-label">應用替換詞：${replaced_words_content}</label></div>`;
      }
      if (offset_words.length !== 0) {
        let offset_words_content = '';
        for (offset_word of offset_words) {
          offset_words_content = offset_words_content + `<span class="badge badge-outline text-wrap text-cyan me-1 mb-1" style="vertical-align: middle;">${offset_word}</span>`;
        }
        content = `${content}<div class="mb-3"><label class="form-label">應用集數偏移：${offset_words_content}</label></div>`;
      }
    }
    if (data.type) {
      content = `${content}<span class="badge bg-blue me-1 mb-1" title="型別">${data.type}</span>`;
    }
    if (data.category) {
      content = `${content}<span class="badge bg-blue me-1 mb-1" title="類別">${data.category}</span>`;
    }
    if (data.name) {
      const name_query_link = `https://www.themoviedb.org/search?query=${encodeURI(data.name)}`;
      content = `${content}<span title="識別名稱"><a class="badge bg-yellow me-1 mb-1" href="${name_query_link}" target="_blank">${data.name}</a></span>`;
    }
    if (data.title) {
      content = `${content}<span class="badge bg-green me-1 mb-1" title="標題">${data.title}</span>`;
    } else {
      content = `${content}<span class="badge bg-red me-1 mb-1" title="標題">未匹配TMDB</span>`;
    }
    if (data.tmdbid) {
      content = `${content}<span title="TMDB ID"><a class="badge bg-green me-1 mb-1" href="${data.tmdblink}" target="_blank">${data.tmdbid}</a></span>`;
    }
    if (data.year) {
      content = `${content}<span class="badge bg-orange me-1 mb-1" title="年份">${data.year}</span>`;
    }
    if (data.season_episode) {
      content = `${content}<span title="季集"><a class="badge bg-orange me-1 mb-1" href="${data.tmdb_S_E_link}" target="_blank">${data.season_episode}</a></span>`;
    }
    if (data.part) {
      content = `${content}<span class="badge bg-orange me-1 mb-1" title="分集">${data.part}</span>`;
    }
    if (data.restype) {
      content = `${content}<span class="badge me-1 mb-1" title="質量">${data.restype}</span>`;
    }
    if (data.effect) {
      content = `${content}<span class="badge me-1 mb-1" title="特性">${data.effect}</span>`;
    }
    if (data.pix) {
      content = `${content}<span class="badge me-1 mb-1" title="解析度">${data.pix}</span>`;
    }
    if (data.video_codec) {
      content = `${content}<span class="badge me-1 mb-1" title="影片編碼">${data.video_codec}</span>`;
    }
    if (data.audio_codec) {
      content = `${content}<span class="badge me-1 mb-1" title="音訊編碼">${data.audio_codec}</span>`;
    }
    if (data.team) {
      content = `${content}<span class="badge bg-cyan me-1 mb-1" title="製作組/字幕組">${data.team}</span>`;
    }
    $(`#${result_div}`).empty().append(content);
  }

  // 顯示手動識別轉移框
  // manual_type: 1-未識別手動識別，2-歷史記錄手動識別，3-自定義識別
  // media_type: 電影，電視劇，動漫
  function show_manual_transfer_modal(manual_type, inpath, syncmod, media_type, unknown_id, transferlog_id) {
    // 初始化型別
    if (!syncmod) {
      syncmod = '{{ SyncMod }}';
    }
    $("#rename_manual_type").val(manual_type);
    if (manual_type === 3) {
      $('#rename_header').text("自定義識別");
      $('#rename_path_div').hide();
      $('#rename_inpath_div').show();
      $('#rename_outpath_div').show();
      $("#rename_inpath").val(inpath);
      $("#rename_outpath").val('');
      $("#rename_syncmod_customize").val(syncmod);
      $("#unknown_id").val("");
      $("#transferlog_id").val("");
    } else {
      $('#rename_header').text("手動識別");
      $('#rename_path_div').show();
      $('#rename_inpath_div').hide();
      $('#rename_outpath_div').hide();
      $("#rename_path").val(inpath);
      $("#rename_syncmod_manual").val(syncmod);
      $("#unknown_id").val(unknown_id);
      $("#transferlog_id").val(transferlog_id);
    }
    // 初始化季列表
    $("#rename_season").empty()
        .append('<option value="" selected>請選擇</option>');
    for (let i = 0; i <= 50; i++) {
      $("#rename_season").append('<option value="' + i + '">第' + i + '季</option>');
    }
    // 初始化媒體型別
    if (media_type === "電視劇") {
      $("#rename_type_tv").prop("checked", true);
      $("#rename_type_mov").removeProp("checked");
      $("#rename_type_anime").removeProp("checked");
      $("#rename_season_div").show();
      $("#rename_episode_div").show();
    } else if (media_type === "動漫") {
      $("#rename_type_anime").prop("checked", true);
      $("#rename_type_tv").removeProp("checked");
      $("#rename_type_mov").removeProp("checked");
      $("#rename_season_div").show();
      $("#rename_episode_div").show();
    } else {
      $("#rename_type_mov").prop("checked", true);
      $("#rename_type_tv").removeProp("checked");
      $("#rename_type_anime").removeProp("checked");
      $("#rename_season_div").hide();
      $("#rename_episode_div").hide();
      $("#rename_season").val("");
    }

    // 清空輸入框
    $("#rename_min_filesize").val("");
    $("#rename_episode").val("");
    $("#rename_episode_details").val("");
    $("#rename_episode_offset").val("");
    $("#rename_season").val("");
    $("#rename_tmdb").val("");

    // 顯示視窗
    $("#modal-media-identification").modal("show");

  }

  // 執行手動識別轉移
  function manual_media_transfer() {
    let syncmod;
    const manual_type = $("#rename_manual_type").val();
    const type = $('input:radio[name=rename_type]:checked').val();
    const path = $("#rename_path").val();
    const inpath = $("#rename_inpath").val();
    const outpath = $("#rename_outpath").val();
    if (manual_type == '3') {
      syncmod = $("#rename_syncmod_customize").val();
    } else {
      syncmod = $("#rename_syncmod_manual").val();
    }
    const tmdb = $("#rename_tmdb").val();
    const season = $("#rename_season").val();
    const episode_format = $("#rename_episode").val();
    const episode_details = $("#rename_episode_details").val();
    const episode_offset = $("#rename_episode_offset").val();
    const min_filesize = $("#rename_min_filesize").val();
    const logid = $("#transferlog_id").val();
    const unknown_id = $('#unknown_id').val();

    if (manual_type == '1' && !unknown_id) {
      return;
    }

    if (manual_type == '2' && !logid) {
      return;
    }

    if (manual_type == '3') {
      if (!inpath) {
        $("#rename_inpath").addClass("is-invalid");
        return;
      } else {
        $("#rename_inpath").removeClass("is-invalid");
      }
    } else {
      if (!path) {
        $("#rename_path").addClass("is-invalid");
        return;
      } else {
        $("#rename_path").removeClass("is-invalid");
      }
    }

    if (min_filesize && isNaN(min_filesize)) {
      $("#rename_min_filesize").addClass("is-invalid");
      return;
    } else {
      $("#rename_min_filesize").removeClass("is-invalid");
    }

    if (episode_details && !/^\d{1,5}([,-]\d{1,5})?$/.test(episode_details)) {
      $("#rename_episode_details").addClass("is-invalid");
      return;
    } else {
      $("#rename_episode_details").removeClass("is-invalid");
    }
    if (episode_offset && !/^-?\d{1,5}$/.test(episode_offset)) {
      $("#rename_episode_offset").addClass("is-invalid");
      return;
    } else {
      $("#rename_episode_offset").removeClass("is-invalid");
    }

    // 開始處理
    const data = {
      "inpath": inpath,
      "outpath": outpath,
      "syncmod": syncmod,
      "type": type,
      "tmdb": tmdb,
      "season": season,
      "episode_format": episode_format,
      "episode_details": episode_details,
      "episode_offset": episode_offset,
      "min_filesize": min_filesize,
      "unknown_id": unknown_id,
      "path": path,
      "logid": logid
    };
    $("#identification_action_btn").attr("disabled", true)
        .text("處理中...");
    $("#rename_udf_retmsg").hide()
    $("#rename_retmsg").hide()
    if (manual_type == '3') {
      cmd = "rename_udf"
    } else {
      cmd = "rename"
    }
    ajax_post(cmd, data, function (ret) {
      $("#identification_action_btn").attr("disabled", false)
          .text("轉移");
      if (ret.retcode == 0) {
        $('#modal-media-identification').modal('hide');
        show_success_modal("處理成功！", function () {
          if (manual_type == '2') {
            navmenu('history');
          } else {
            navmenu('unidentification');
          }
        });
      } else {
        //處理失敗
        regmsg = ret.retmsg;
        if (manual_type == '3') {
          $("#rename_udf_retmsg").show()
              .text(regmsg)
        } else {
          $("#rename_retmsg").show()
              .text(regmsg)
        }
      }
    });

  }

</script>

<!-- 首頁功能 -->
<script type="text/javascript">
  //當前頁面地址
  let CURRENT_PAGE_URI = "";

  //導航點選
  function navmenu(page) {
    $("#navbar-menu li").find("a").removeClass("active").each(function () {
      if ($(this).attr("onclick") && $(this).attr("onclick").includes("navmenu('" + page + "')")) {
        $(this).addClass("active");
        if ($(this).hasClass('dropdown-item')) {
          $(this).parent().addClass("show");
        }
      }
    });
    $("#navbar-menu").collapse('hide');
    show_wait_process();
    $(".page-wrapper").unbind('scroll');
    page = page.replaceAll(" ", "%20");
    CURRENT_PAGE_URI = page;
    $("#page_content").load(page, {}, function (response, status, xhr) {
      hide_wait_process();
      if ($("#page_content").find("title").first().text() == "登入 - NAStool") {
        window.location.reload();
      } else {
        fresh_tooltip();
        init_filetree_element();
      }
    });
  }

  //重新整理LOG標誌
  let refresh_logging_flag = false;

  //開始重新整理日誌
  function start_logging() {
    refresh_logging_flag = true;
    refresh_logging();
  }

  //停止重新整理日誌
  function stop_logging() {
    refresh_logging_flag = false;
  }

  //重新整理日誌
  function refresh_logging(flag) {
    let refresh_new = $("#logging_content").children().length;
    ajax_post("logging", {"refresh_new": refresh_new}, function (ret) {
      if (ret.loglist) {
        let log_list = ret.loglist;
        let tdstyle = "padding-top: 0.5rem; padding-bottom: 0.5rem";
        let tbody = "";
        for (let i = 0; i < log_list.length; i++) {
          const log =  log_list[i];
          let text = log.text;
          const source = log.source;
          const time = log.time;
          const level = log.level;
          let tcolor = '';
          let bgcolor = '';
          let tstyle = '';
          if (level === "WARN") {
            tcolor = "text-warning";
            bgcolor = "bg-warning";
          } else if (level === "ERROR") {
            tcolor = "text-danger";
            bgcolor = "bg-danger";
          } else if (source === "System") {
            tcolor = "text-info";
            bgcolor = "bg-info";
          } else {
            tcolor = "text";
          }
          if (["Rmt", "Subtitle"].includes(source) && text.includes(" 到 ")) {
            tstyle = `white-space: pre;`
            text = text.replace(/\s到\s/, "\n=> ")
          }
          if (text.includes("http") || text.includes("magnet")) {
            tstyle = `word-break: break-all;`
            text = text.replace(/：((?:http|magnet).+?)(?:\s|$)/g, "：<a href='$1' target='_blank'>$1</a>")
          }
          tbody = `${tbody}
                    <tr>
                    <td style="${tdstyle}"><span class="${tcolor}">${time}</span></td>
                    <td style="${tdstyle}"><span class="badge ${bgcolor}">${source}</span></td>
                    <td style="${tdstyle}"><span class="${tcolor}" style="${tstyle}">${text}</span></td>
                    </tr>`;
        }
        let bool_ToScrolTop = ($("#logging_table").scrollTop() + $("#logging_table").prop("offsetHeight")) >= $("#logging_table").prop("scrollHeight");
        $("#logging_content").append(tbody);
        if (bool_ToScrolTop){
          setTimeout(function () {
            $("#logging_table").scrollTop($("#logging_table").prop("scrollHeight"));
          }, 500);
        }
      }
      if ($("#modal-logging").is(":hidden") && flag) {
        stop_logging();
      }
      if (refresh_logging_flag == true) {
        setTimeout("refresh_logging(true)", 2000);
      }
    });
  }

  //暫停實時日誌
  function pause_logging() {
    if (refresh_logging_flag == true) {
      stop_logging();
      $("#logging_stop_btn").text("開始")
    } else {
      start_logging();
      $("#logging_stop_btn").text("暫停")
    }
  }

  //實時日誌關閉
  $("#logging_close_btn").click(function () {
    stop_logging();
  });

  $("#logging_close_head").click(function () {
    stop_logging();
  });

  // 顯示實時日誌
  function show_logging_modal() {
    start_logging();
    $('#modal-logging').modal('show');
  }

  //重新整理訊息中心
  function refresh_message(time_str) {
    ajax_post("refresh_message", {"lst_time": time_str}, function (ret) {
      if (ret.code === 0) {
        let lst_time = ret.lst_time;
        const msgs = ret.message;
        for (let i = 0; i < msgs.length; i++) {
          $("#system-messages").prepend(msgs[i]);
        }
        setTimeout("refresh_message('" + lst_time + "')", 10000);
      }
    });
  }

  // 檢查新版本
  const AppVersion = "{{ AppVersion }}".split(" ")[0];
  let NewVersion = '';
  $("#new_version_tip").hide();

  function check_new_version() {
    ajax_post("version", {}, function (ret) {
      if (ret.code === 0) {
        if (ret.version != AppVersion) {
          $("#new_version_info").html(ret.info);
          $("#new_version_tip").show();
          NewVersion = ret.version;
        }
      }
    });
  }

  //檢查系統是否線上
  function check_system_online() {
    ajax_post("refresh_process", {type: "restart"}, function (ret) {
        if (ret.code === -1) {
          logout();
        } else {
          setTimeout("check_system_online()", 1000);
        }
      });
  }

  //登出
  function logout() {
    ajax_post("logout", {}, function (ret) {
      window.location.href = "/";
    });
  }

  //重啟
  function restart() {
    show_confirm_modal("立即重啟系統？", function () {
      hide_confirm_modal();
      ajax_post("restart", {}, function (ret) {
      });
      show_wait_process(true);
      setTimeout("check_system_online()", 5000);
    });
  }

  //更新
  function update(version) {
    let title;
    if (version) {
      title = "是否確認更新到 " + version + " 版本？";
    } else {
      title = "將從Github拉取最新程式程式碼並重啟，是否確認？";
    }
    show_confirm_modal(title, function () {
      hide_confirm_modal();
      ajax_post("update_system", {}, function (ret) {
      });
      show_wait_process(true);
      setTimeout("check_system_online()", 5000);
    });
  }

  //滾動到頂步
  function ScrollToTop() {
    $("#page_wrapper").animate({
      scrollTop: 0
    }, 500);
  }
</script>

<!-- 事件  -->
<script type="text/javascript">
  //瀏覽器相容
  String.prototype.replaceAll = function (s1, s2) {
    return this.replace(new RegExp(s1, "gm"), s2)
  }

  //事件
  $(document).ready(function () {
    // 搜尋輸入框
    $('.home_search_word').bind('keypress', function (event) {
      if (event.keyCode == "13") {
        if (!$(this).val()) {
          return;
        }
        navmenu('medialist?s=' + $(this).val() + '&f=1');
        $(this).val('');
      }
    });

    // tooltip點選事件處理，阻止冒泡到上級元素，避免比如`點選tooltip切換了switch`的問題
    $('body').on('click', 'span[data-bs-toggle="tooltip"]', function (e) {
      e.preventDefault();
      e.stopPropagation();
    });

    /**
     * 計算選單列表高度
     * @return {number}
     */
    function computeMenuListHeight() {
      // '#navbar-menu > .order-first' 要開啟選單後才會顯示，所以這裡取固定值36
      const menuFirstHeight = 36;
      // 這個是經過測試得到的數值
      const extra = 120;
      return $('.navbar-brand').outerHeight() + menuFirstHeight + extra
    }

    /**
     * 更新選單列表高度
     */
    function updateMenuListHeight() {
      const height = computeMenuListHeight();
      $('.navbar ul.navbar-nav').css({
        maxHeight: 'calc(100vh - ' + height + 'px)'
      })
    }

    updateMenuListHeight()

    //單選框事件
    $('input[type=radio][name=rename_type]').change(function () {
      if (this.value == 'MOV') {
        $("#rename_season_div").hide();
        $("#rename_episode_div").hide();
        $("#rename_season").val('');
      } else {
        $("#rename_season_div").show();
        $("#rename_episode_div").show();
      }
    });

    //載入頁面
    const go_page = "{{ GoPage }}";
    if (go_page) {
      navmenu(go_page);
    } else {
      //開啟第一個頁面
      $("#navbar-menu").find("a[onclick]").first().trigger('click');
    }

    {% if "系統設定" in UserPris %}
      //檢查版本升級
      check_new_version();
      //重新整理訊息
      refresh_message("");
    {% endif %}

    {% if not TMDBFlag %}
      //檢查tmdb配置
      show_fail_modal("請先配置TMDB API Key，並修改登入密碼！", function () {
        navmenu('basic');
      });
    {% endif %}

  });
</script>
</body>

</html>