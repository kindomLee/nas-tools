<div class="container-xl">
  <!-- Page title -->
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">
          自定義訂閱
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="javascript:show_userrss_modal()" class="btn btn-primary d-none d-sm-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            新建訂閱任務
          </a>
          <a href="javascript:show_userrss_modal()" class="btn btn-primary d-sm-none btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
          </a>
          <a href="javascript:navmenu('rss_parser')" class="btn d-none d-sm-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-cpu" width="24" height="24"
              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
              stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <rect x="5" y="5" width="14" height="14" rx="1"></rect>
              <path d="M9 9h6v6h-6z"></path>
              <path d="M3 10h2"></path>
              <path d="M3 14h2"></path>
              <path d="M10 3v2"></path>
              <path d="M14 3v2"></path>
              <path d="M21 10h-2"></path>
              <path d="M21 14h-2"></path>
              <path d="M14 21v-2"></path>
              <path d="M10 21v-2"></path>
            </svg>
            RSS解析器
          </a>
          <a href="javascript:navmenu('rss_parser')" class="btn d-sm-none btn-icon" title="RSS解析器">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-cpu" width="24" height="24"
              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
              stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <rect x="5" y="5" width="14" height="14" rx="1"></rect>
              <path d="M9 9h6v6h-6z"></path>
              <path d="M3 10h2"></path>
              <path d="M3 14h2"></path>
              <path d="M10 3v2"></path>
              <path d="M14 3v2"></path>
              <path d="M21 10h-2"></path>
              <path d="M21 14h-2"></path>
              <path d="M14 21v-2"></path>
              <path d="M10 21v-2"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% if Count > 0 %}
<div class="page-body">
  <div class="container-xl">
    <div class="row row-cards">
      {% for Task in Tasks %}
      <div class="card">
        <div class="card-header">
          {% if Task.state == 'Y' %}
          <span class="badge bg-green"></span>
          {% else %}
          <span class="badge bg-red"></span>
          {% endif %}
          <div class="ms-2"><h3 class="card-title">{{ Task.name }}</h3></div>
          <div class="ms-2">
            <a href="javascript:run_userrss_now('{{ Task.id }}')" class="btn-icon" title="立即執行任務"
              data-bs-toggle="tooltip">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-bolt icon-filled" width="24"
                height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <polyline points="13 3 13 10 19 10 11 21 11 14 5 14 13 3"></polyline>
              </svg>
            </a>
          </div>
          <div class="card-actions btn-actions">
            <a href="javascript:$('#detail_{{ Task.id }}').slideToggle()" class="btn-action">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="20" height="20" fill="currentColor"
                viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                  d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z" />
              </svg>
            </a>
            {% if Task.uses == 'D' %}
            <a href="javascript:show_rss_articles_modal('{{ Task.id }}')" class="btn-action">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-eye" width="24" height="24"
                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <circle cx="12" cy="12" r="2"></circle>
                <path d="M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7">
                </path>
              </svg>
            </a>
            {% endif %}
            <a href="javascript:edit_userrss_modal('{{ Task.id }}')" class="btn-action" title="編輯任務">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M9 7h-3a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-3" />
                <path d="M9 15h3l8.5 -8.5a1.5 1.5 0 0 0 -3 -3l-8.5 8.5v3" />
                <line x1="16" y1="5" x2="19" y2="8" />
              </svg>
            </a>
            <a href="javascript:del_userrss_modal('{{ Task.id }}', '{{ Task.name }}')" class="btn-action" title="刪除任務">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <desc>Download more icon variants from https://tabler-icons.io/i/x</desc>
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </a>
          </div>
        </div>
        <div class="card-body" id="detail_{{ Task.id }}"
          style="display: {% if Count > 2 %}none{% else %}block{% endif %};">
          <div class="datagrid">
            <div class="datagrid-item">
              <div class="datagrid-title">地址</div>
              <div class="datagrid-content">
                <div class="d-flex align-items-center" style="word-break: break-all;">
                  {{ Task.address|split('?', 0) }}
                </div>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">解析器</div>
              <div class="datagrid-content">
                <span class="badge me-2">{{ Task.parser_name }}</span>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">重新整理間隔</div>
              <div class="datagrid-content">
                {{ Task.interval }} 分鐘
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">動作</div>
              <div class="datagrid-content">
                <span class="badge me-2 bg-blue">{{ Task.uses_text }}</span>
              </div>
            </div>
            <div class="datagrid-item" style="display: {% if Task.uses != 'D' %}none{% else %}block{% endif %};">
              <div class="datagrid-title">包含</div>
              <div class="datagrid-content">
                {% if Task.include %}
                <span class="badge badge-outline text-green me-2 text-wrap text-start">{{ Task.include }}</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item" style="display: {% if Task.uses != 'D' %}none{% else %}block{% endif %};">
              <div class="datagrid-title">排除</div>
              <div class="datagrid-content">
                {% if Task.exclude %}
                <span class="badge badge-outline text-red me-2 text-wrap text-start">{{ Task.exclude }}</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item" style="display: {% if Task.uses != 'D' %}none{% else %}block{% endif %};">
              <div class="datagrid-title">過濾規則</div>
              <div class="datagrid-content">
                {% if Task.filter_name %}
                <span class="badge badge-outline text-orange me-2">{{ Task.filter_name }}</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item" style="display: {% if Task.uses != 'D' %}none{% else %}block{% endif %};">
              <div class="datagrid-title">儲存路徑</div>
              <div class="datagrid-content">{{ Task.save_path or '自動' }}</div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">狀態</div>
              <div class="datagrid-content">
                {% if Task.state == 'Y' %}
                <span class="badge me-2 bg-green">正在執行</span>
                {% else %}
                <span class="badge me-2 bg-red">已停用</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">已處理數量</div>
              <div class="datagrid-content">
                {% if Task.uses == 'D' %}
                <a id="rss_history_btn" href="javascript:show_rss_history_modal('{{ Task.id }}')" class="btn-link">
                  {{ Task.counter or 0 }}
                </a>
                {% else %}
                {{ Task.counter or 0 }}
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">最後更新時間</div>
              <div class="datagrid-content">
                {{ Task.update_time or '' }}
              </div>
            </div>
            {% if Task.uses == 'D' %}
            <div class="datagrid-item">
              <div class="datagrid-title">下載設定</div>
              <div class="datagrid-content">
                {% if Task.download_setting|string in DownloadSettings %}
                <span class="badge me-2 bg-yellow">{{ DownloadSettings[Task.download_setting|string].name }}</span>
                {% else %}
                <span class="badge me-2 bg-red">{{ DownloadSettings["-1"].name }}</span>
                {% endif %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% else %}
<div class="page-body">
  <div class="container-xl d-flex flex-column justify-content-center">
    <div class="empty">
      <div class="empty-img"><img src="./static/img/quitting_time.svg" height="128" alt="">
      </div>
      <p class="empty-title">沒有記錄</p>
      <p class="empty-subtitle text-muted">
        當前沒有正在執行的自定義訂閱任務
      </p>
    </div>
  </div>
</div>
{% endif %}
<div class="modal modal-blur fade" id="modal-userrss" tabindex="-1" role="dialog" aria-hidden="true"
  data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userrss_modal_title"></h5>
        <input type="hidden" id="userrss_id">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="overflow-x: hidden">
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">名稱</label>
              <input type="text" id="userrss_name" class="form-control" placeholder="別名">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">狀態</label>
              <select class="form-select" id="userrss_state">
                <option value="Y" selected>正常</option>
                <option value="N">停用</option>
              </select>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">重新整理間隔(分鐘) <span class="form-help" title="檢查RSS更新的間隔時間"
                  data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="userrss_interval" class="form-control" placeholder="30">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-8">
            <div class="mb-3">
              <label class="form-label required">地址 <span class="form-help" title="RSS訂閱的連結地址"
                  data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="userrss_address" class="form-control" placeholder="RSS地址">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">解析器 <span class="form-help" title="使用RSS解析器中配置的解析格式解析RSS報文"
                  data-bs-toggle="tooltip">?</span></label>
              <select class="form-select" id="userrss_parser">
                {% for RssParser in RssParsers %}
                <option value="{{ RssParser.id }}" {% if loop.first %}selected{% endif %}>{{ RssParser.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="form-selectgroup-boxes row mb-3">
          <label class="form-label required">動作</label>
          <div class="col-lg-4">
            <div class="mb-1">
              <label class="form-selectgroup-item" for="use_D">
                <input type="radio" name="userrss_uses" id="use_D" value="D" class="form-selectgroup-input" checked>
                <span class="form-selectgroup-label d-flex align-items-center p-3">
                  <span class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </span>
                  <span class="form-selectgroup-label-content">
                    <span class="form-selectgroup-title strong mb-1">下載</span>
                  </span>
                </span>
              </label>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-1">
              <label class="form-selectgroup-item" for="use_R">
                <input type="radio" name="userrss_uses" id="use_R" value="R" class="form-selectgroup-input">
                <span class="form-selectgroup-label d-flex align-items-center p-3">
                  <span class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </span>
                  <span class="form-selectgroup-label-content">
                    <span class="form-selectgroup-title strong mb-1">訂閱</span>
                  </span>
                </span>
              </label>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-1">
              <label class="form-selectgroup-item" for="use_S">
                <input type="radio" name="userrss_uses" id="use_S" value="S" class="form-selectgroup-input">
                <span class="form-selectgroup-label d-flex align-items-center p-3">
                  <span class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </span>
                  <span class="form-selectgroup-label-content">
                    <span class="form-selectgroup-title strong mb-1">搜尋</span>
                  </span>
                </span>
              </label>
            </div>
          </div>
        </div>
        <div class="row" id="filter_div">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">包含 <span class="form-help" title="RSS報文中title符合包括規則的才會被處理"
                  data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="userrss_include" class="form-control" placeholder="關鍵字/正規表示式">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">排除 <span class="form-help" title="RSS報文中title符合排除規則的則不會被處理"
                  data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="userrss_exclude" class="form-control" placeholder="關鍵字/正規表示式">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">過濾規則 <span class="form-help" title="只有符合過濾規則的才會被處理"
                  data-bs-toggle="tooltip">?</span></label>
              <select class="form-select" id="userrss_filterrule">
                <option value="" selected>請選擇</option>
                {% for FilterRule in FilterRules %}
                <option value="{{ FilterRule.id }}">{{ FilterRule.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="row" id="downloader_setting_div">
          <div class="col-lg-8">
            <div class="mb-3">
              <label class="form-label">儲存路徑</label>
              <input type="text" id="userrss_save_path" class="form-control" placeholder="留空自動選擇儲存路徑">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">下載設定</label>
              <select class="form-select" id="userrss_download_setting">
                {% for Id, Attr in DownloadSettings.items() %}
                <option value="{{ Attr.id }}">{{ Attr.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        {% if Count > 0 %}
        <details>
          <summary class="summary">
            模板
          </summary>
          <div class="row mt-2">
            <div class="form-selectgroup">
              {% for Task in Tasks %}
              <label class="form-selectgroup-item">
                <input type="button" class="form-selectgroup-input" onclick="apply_templated('{{ Task.id }}')">
                <span class="form-selectgroup-label">{{ Task.name }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </details>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link me-auto" data-bs-dismiss="modal">取消</button>
        <a href="javascript:add_or_edit_userrss_task()" id="add_or_edit_userrss_btn" class="btn btn-primary">儲存</a>
      </div>
    </div>
  </div>
</div>
<div class="modal modal-blur fade" id="modal-rss-articles" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="ms-2">
          <h5 class="modal-title">訂閱預覽</h5>
          <input type="hidden" id="article_check_id" value="" >
        </div>
        <div class="ms-5">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>      
      <div class="table-responsive" style="overflow-y: auto; max-height: 35em;">
        <table id="table-rss-articles" class="table table-vcenter card-table">
        </table>
      </div>
      <div class="modal-footer">
        <a href="javascript:batch_articles_action('download')"
          class="btn btn-primary me-auto">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="24" height="24"
            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
            stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
            <polyline points="7 11 12 16 17 11"></polyline>
            <line x1="12" y1="4" x2="12" y2="16"></line>
          </svg>
          批次下載
        </a>
        <a href="javascript:batch_articles_action('set_finished')"
          class="btn btn-green">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-circle-check" width="24"
            height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
            stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M9 12l2 2l4 -4"></path>
          </svg>
          已處理</a>
        <a href="javascript:batch_articles_action('set_unfinish')"
          class="btn btn-yellow">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-circle-x" width="24" height="24"
            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
            stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M10 10l4 4m0 -4l-4 4"></path>
          </svg>
          未處理
        </a>
      </div>
    </div>
  </div>
</div>
<div class="modal modal-blur fade" id="modal-rss-history" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">訂閱下載歷史</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="table-responsive" style="overflow-y: auto; max-height: 35em;">
        <table id="table-rss-history" class="table table-vcenter card-table">
        </table>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  // 顯示新增任務
  function show_userrss_modal() {
    $("#userrss_id").val('');
    $("#userrss_modal_title").text("新增訂閱");
    $("#userrss_name").val('');
    $("#userrss_interval").val('');
    $("#userrss_address").val('');
    $("#userrss_include").val('');
    $("#userrss_exclude").val('');
    $("#userrss_filterrule").val('');
    $("#userrss_parser").val('1');
    $("#userrss_state").val('N');
    show_userrss_uses('D');
    $("#userrss_save_path").val('');
    $("#userrss_download_setting").val('-1');
    $("#modal-userrss").modal('show');
  }

  // 顯示編輯任務
  function edit_userrss_modal(id) {
    $("#userrss_id").val(id);
    show_wait_process();
    ajax_post("get_userrss_task", { id: id }, function (ret) {
      hide_wait_process();
      if (ret.code == 0) {
        $("#userrss_modal_title").text("編輯訂閱");
        $("#userrss_name").val(ret.detail.name);
        $("#userrss_interval").val(ret.detail.interval);
        $("#userrss_address").val(ret.detail.address);
        $("#userrss_include").val(ret.detail.include);
        $("#userrss_exclude").val(ret.detail.exclude);
        $("#userrss_filterrule").val(ret.detail.filter);
        $("#userrss_parser").val(ret.detail.parser);
        $("#userrss_state").val(ret.detail.state);
        show_userrss_uses(ret.detail.uses);
        $("#userrss_save_path").val(ret.detail.save_path);
        $("#userrss_download_setting").val(ret.detail.download_setting);
        $("#modal-userrss").modal('show');
      }
    });
  }

  // 顯示刪除任務
  function del_userrss_modal(taskid, name) {
    show_confirm_modal("刪除訂閱任務 " + name + " ？", function () {
      hide_confirm_modal();
      ajax_post("delete_userrss_task", { "id": taskid }, function (ret) {
        navmenu('user_rss');
      });
    });
  }

  // 新增/編輯任務儲存
  function add_or_edit_userrss_task() {
    const id = $("#userrss_id").val();
    const name = $("#userrss_name").val();
    if (!name) {
      $("#userrss_name").addClass("is-invalid");
      return;
    } else {
      $("#userrss_name").removeClass("is-invalid");
    }
    const interval = $("#userrss_interval").val();
    if (!interval || isNaN(interval)) {
      $("#userrss_interval").addClass("is-invalid");
      return;
    } else {
      $("#userrss_interval").removeClass("is-invalid");
    }
    const address = $("#userrss_address").val();
    if (!address) {
      $("#userrss_address").addClass("is-invalid");
      return;
    } else {
      $("#userrss_address").removeClass("is-invalid");
    }
    const parser = $("#userrss_parser").val();
    if (!parser) {
      $("#userrss_parser").addClass("is-invalid");
      return;
    } else {
      $("#userrss_parser").removeClass("is-invalid");
    }
    const params = {
      id: id,
      name: name,
      address: address,
      parser: parser,
      interval: interval,
      uses: $('input:radio[name=userrss_uses]:checked').val(),
      include: $("#userrss_include").val(),
      exclude: $("#userrss_exclude").val(),
      filterrule: $("#userrss_filterrule").val(),
      state: $("#userrss_state").val(),
      save_path: $("#userrss_save_path").val(),
      download_setting: $("#userrss_download_setting").val(),
    };
    $("#add_or_edit_userrss_btn").text("儲存中").attr("disabled", true);
    ajax_post("update_userrss_task", params, function (ret) {
      $("#modal-userrss").modal('hide');
      $("#add_or_edit_userrss_btn").attr("disabled", false);
      navmenu('user_rss');
    });
  }

  // 立即執行任務
  function run_userrss_now(id) {
    show_wait_process();
    ajax_post("run_userrss", { "id": id }, function (ret) {
      hide_wait_process();
      show_success_modal("任務執行完成！", function () {
        navmenu('user_rss');
      });
    });
  }

  // 報文預覽
  function show_rss_articles_modal(id) {
    show_wait_process();
    ajax_post("list_rss_articles", { "id": id }, function (ret) {
      let content  ; hide_wait_process();
      $("#table-rss-articles").empty();
      if (ret.code == 0) {
        const articles = ret.data;
        let content_th = `<thead><tr>
                          <th class="w-1"><input class="form-check-input m-0 align-middle" id="articles_check_all_btn" type="checkbox" aria-label="全選"></th>
                          <th>標題</th>
                          <th>狀態</th>
                          <th>釋出時間</th>
                          <th></th>
                          </tr></thead>`;
        let content_td = '';
        for (let i = 0; i < articles.length; i++) {
          const article = articles[i];
          let title = '';
          let size = '';
          let date = '';
          let finish_flag = '';
          let input_checkbox = '';
          if (article.title) {
            const title_param = article.title.replace(/\'/g, "&#39;");
            input_checkbox = `<input class="form-check-input m-0 align-middle" id="check_${i}" type="checkbox">
                              <input type="hidden" id="enclosure_${i}" value="${article.enclosure}">
                              <input type="hidden" id="title_${i}" value="${title_param}">`;
            title = `<span>${article.title}</span> 
                      <a class="ms-2" title="識別匹配" href='javascript:rss_article_test("${i}", "${id}", "${title_param}")' data-bs-toggle="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-text-recognition" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                           <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                           <path d="M4 8v-2a2 2 0 0 1 2 -2h2"></path>
                           <path d="M4 16v2a2 2 0 0 0 2 2h2"></path>
                           <path d="M16 4h2a2 2 0 0 1 2 2v2"></path>
                           <path d="M16 20h2a2 2 0 0 0 2 -2v-2"></path>
                           <path d="M12 16v-7"></path>
                           <path d="M9 9h6"></path>
                        </svg>
                      </a>`;
            if (article.link) {
              title = `<a href="${article.link}" target="_blank">${title}</a>`;
            }
          }
          if (article.date) {
            date = article.date.split(" ");
            date = `<small>${date[0]}<br>${date[1]}</small>`;
          }
          if (article.size) {
            size = `<span class="badge badge-outline text-green me-1 mb-1" title="大小">${article.size}</span>`;
          }
          if (article.finish_flag) {
            finish_flag = `<span class="badge badge-outline text-blue me-1 mb-1">已處理</span>`;
          } else {
            finish_flag = `<span class="badge badge-outline text-yellow me-1 mb-1">未處理</span>`;
          }
          let download_btn = `<a href='javascript:single_article_download("${id}", "${i}")' title="下載">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                              <polyline points="7 11 12 16 17 11"></polyline>
                              <line x1="12" y1="4" x2="12" y2="16"></line>
                            </svg>
                          </a>`
          content_td= `${content_td}<tr><td>${input_checkbox}</td><td>${title}${size}<div id='info_${i}'></div></td>><td>${finish_flag}<a id='flag_${i}'></a></td><td class="text-nowrap">${date}</td><td>${download_btn}</td></tr>`;
          let content_tb = `<tbody>${content_td}</tbody>`;
          content = `${content_th}${content_tb}`;
        }

        $("#table-rss-articles").append(content);
        // 繫結全選事件
        $("#articles_check_all_btn").bind("change", function () {
          $(".table-responsive input[type=checkbox]").prop("checked", $("#articles_check_all_btn").prop("checked"));
        });
      } else {
        content= `<div class="empty"><p class="empty-title">${ret.msg}</p></div>`;
        $("#table-rss-articles").append(content);
      };
      $("#article_check_id").val(id);
      $("#modal-rss-articles").modal('show');
    });
  }

  // 獲取選中按鈕
  function get_article_checked(){
    let articles = [];
    $(".table-responsive input[type=checkbox]").each(function () {
      if ($(this).prop("checked")) {
        const checkid = $(this).attr("id");
        if (checkid && checkid.startsWith("check_")) {
          const title = $(`#${checkid.replace("check", "title")}`).val();
          const enclosure = $(`#${checkid.replace("check", "enclosure")}`).val();
          if (title || enclosure) {
            articles.push({ title: title, enclosure: enclosure })
          }
        }
      }
    });
    return articles;
  }


  // 批次處理
  function batch_articles_action(flag) {
    const articles = get_article_checked();
    const id = $("#article_check_id").val();
    if (articles.length == 0) {
      return;
    }
    if (flag.startsWith("set_")) {
      articles_check(id, flag, articles);
    } else if (flag == "download") {
      articles_download(id, articles);
    }
  }


  // 報文處理設定
  function articles_check(id, flag, articles) {
    $("#modal-rss-articles").modal('hide');
    show_wait_process();
    ajax_post("rss_articles_check", { "articles": articles, "flag": flag }, function (ret) {
      hide_wait_process();
      show_rss_articles_modal(id);
    });
  }

  // 報文下載
  function articles_download(id, articles) {
    $("#modal-rss-articles").modal('hide');
    show_wait_process();
    ajax_post("rss_articles_download", { "articles": articles, "taskid": id }, function (ret) {
      hide_wait_process();
      if (ret.code == 0) {
        show_success_modal("新增下載成功！", function() {
          show_rss_articles_modal(id);//
        });
      } else if (ret.code == 1) {
        show_fail_modal(" 新增下載失敗！", function() {
          show_rss_articles_modal(id);//
        });
      }
    });
  }

  // 單個報文下載
  function single_article_download(id, article_id) {
    const article = [{ title: $(`#title_${article_id}`).val(), enclosure: $(`#enclosure_${article_id}`).val() }];
    articles_download(id, article);
  }

  // rss報文測試
  function rss_article_test(id, taskid, title) {
    const info_id = `info_${id}`;
    const flag_id = `#flag_${id}`;
    make_cursor_busy();
    ajax_post("rss_article_test", { "taskid": taskid, "title": title }, function (ret) {
      cancel_cursor_busy();
      if (ret.code === 0) {
        $(flag_id).empty();
        media_name_test_ui(ret.data, info_id);
      }
    })
  }

  // 訂閱下載記錄
  function show_rss_history_modal(id) {
    show_wait_process();
    ajax_post("list_rss_history", { "id": id }, function (ret) {
      let content;
      hide_wait_process();
      if (ret.code == 0) {
        const downloads = ret.data;
        let content_th = `<thead><tr>
                          <th>標題</th>
                          <th>下載器</th>
                          <th>下載時間</th>
                          </tr></thead>`;
        let content_td = '';
        for (let i = 0; i < downloads.length; i++) {
          const download = downloads[i];
          let title = '';
          let downloader = '';
          let date = '';
          if (download.title) {
            title = `<span>${download.title}</span>`
          };
          if (download.date) {
            date = download.date.split(" ");
            date = `<small>${date[0]}<br>${date[1]}</small>`;
          };
          if (download.downloader) {
            downloader = `<span class="badge me-1 mb-1" title="下載器">${download.downloader}</span>`;
          };
          content_td = `${content_td}<tr><td>${title}</td>><td>${downloader}</td><td class="text-nowrap">${date}</td></tr>`;
          let content_tb = `<tbody>${content_td}</tbody>`;
          content = `${content_th}${content_tb}`;
        };
      } else {
        content= `<div class="empty"><p class="empty-title">${ret.msg}</p></div>`;
      }
      $("#table-rss-history").empty().append(content);
      $("#modal-rss-history").modal('show');
    });
  }

  // 應用訂閱模板
  function apply_templated(id) {
    ajax_post("get_userrss_task", { id: id }, function (ret) {
      if (ret.code == 0) {
        $("#userrss_interval").val(ret.detail.interval);
        $("#userrss_include").val(ret.detail.include);
        $("#userrss_exclude").val(ret.detail.exclude);
        $("#userrss_filterrule").val(ret.detail.filter);
        $("#userrss_parser").val(ret.detail.parser);
        $("#userrss_state").val(ret.detail.state);
        show_userrss_uses(ret.detail.uses);
        $("#userrss_save_path").val(ret.detail.save_path);
        $("#userrss_download_setting").val(ret.detail.download_setting);
      }
    });
  }

  // 單選框事件
  $('input[type=radio][name=userrss_uses]').change(function () {
    show_userrss_uses(this.value);
  });

  // 自定義訂閱動作 D:下載 R:訂閱 S:搜尋
  function show_userrss_uses(use) {
    if (use == 'D') {
      $("#downloader_setting_div").show();
      $("#filter_div").show();
      $("#use_D").prop("checked", true);
    }
    else if (use == 'R') {
      $("#downloader_setting_div").hide();
      $("#filter_div").hide();
      $("#use_R").prop("checked", true);
    }
    else if (use == 'S') {
      $("#downloader_setting_div").hide();
      $("#filter_div").hide();
      $("#use_S").prop("checked", true);
    }
  }
</script>