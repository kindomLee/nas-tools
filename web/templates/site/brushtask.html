<div class="container-xl">
  <!-- Page title -->
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">
          刷流任務
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="javascript:show_brushtask_modal()" class="btn btn-primary d-none d-sm-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                 stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            新建任務
          </a>
          <a href="javascript:show_brushtask_modal()" class="btn btn-primary d-sm-none btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                 stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
          </a>
          <a href="javascript:navmenu('userdownloader')" class="btn d-none d-sm-inline-block" title="自定義下載器">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-apps" width="40" height="40"
                 viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                 stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <rect x="4" y="4" width="6" height="6" rx="1"></rect>
              <rect x="4" y="14" width="6" height="6" rx="1"></rect>
              <rect x="14" y="14" width="6" height="6" rx="1"></rect>
              <line x1="14" y1="7" x2="20" y2="7"></line>
              <line x1="17" y1="4" x2="17" y2="10"></line>
            </svg>
            自定義下載器
          </a>
          <a href="javascript:navmenu('userdownloader')" class="btn d-sm-none btn-icon" title="自定義下載器">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-apps" width="40" height="40"
                 viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                 stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <rect x="4" y="4" width="6" height="6" rx="1"></rect>
              <rect x="4" y="14" width="6" height="6" rx="1"></rect>
              <rect x="14" y="14" width="6" height="6" rx="1"></rect>
              <line x1="14" y1="7" x2="20" y2="7"></line>
              <line x1="17" y1="4" x2="17" y2="10"></line>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% if Count > 0 %}
  <div class="page-body">
    <div class="container-xl">
      <div class="row row-cards">
        {% for Task in Tasks %}
          <div class="card">
            <div class="card-header">
              {% if Task.state == 'Y' %}
              <span class="badge bg-green"></span>
              {% else %}
              <span class="badge bg-red"></span>
              {% endif %}
              <div class="ms-2">
                <h3 class="card-title">{{ Task.name }}</h3>
              </div>
              <div class="ms-2">
                <a href="javascript:run_brushtask_now('{{ Task.id }}')" class="btn-icon" title="立即執行任務"
                   data-bs-toggle="tooltip">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-bolt icon-filled"
                       width="24"
                       height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                       stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <polyline points="13 3 13 10 19 10 11 21 11 14 5 14 13 3"></polyline>
                  </svg>
                </a>
              </div>
              <div class="text-muted ms-3" id="detail_size_{{ Task.id }}"
                style="display: {% if Count > 2 %}block{% else %}none{% endif %};">↑{{ Task.upload_size }}  ↓{{ Task.download_size }}</div>
              <div class="card-actions btn-actions">
                <a href="javascript:show_brushtask_detail('{{ Task.id }}')" class="btn-action">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="20" height="20" fill="currentColor"
                    viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                      d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z" />
                  </svg>
                </a>
                <a href="javascript:edit_brushtask_modal('{{ Task.id }}')" class="btn-action" title="編輯任務">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="24" height="24" viewBox="0 0 24 24"
                       stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                       stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M9 7h-3a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-3"/>
                    <path d="M9 15h3l8.5 -8.5a1.5 1.5 0 0 0 -3 -3l-8.5 8.5v3"/>
                    <line x1="16" y1="5" x2="19" y2="8"/>
                  </svg>
                </a>
                <a href="javascript:del_brushtask_modal('{{ Task.id }}', '{{ Task.name }}')" class="btn-action"
                   title="刪除任務">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                       stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                       stroke-linejoin="round">
                    <desc>Download more icon variants from https://tabler-icons.io/i/x</desc>
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </a>
              </div>
            </div>
            <div class="card-body" id="detail_{{ Task.id }}"
                style="display: {% if Count > 2 %}none{% else %}block{% endif %};">
              <div class="datagrid">
                <div class="datagrid-item">
                  <div class="datagrid-title">站點</div>
                  <div class="datagrid-content">
                    <div class="d-flex align-items-center">
                      <span class="avatar avatar-sm rounded me-2 siteicon-{{ Task.site|hash }}" width="24" height="24" alt="" style="cursor:pointer"></span>
                      <h3>{{ Task.site }}</h3>
                    </div>
                  </div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">促銷</div>
                  <div class="datagrid-content">
                    {% if Task.free %}<span class="badge me-2 bg-green">{{ Task.free }}</span>
                    {% else %}
                      <span class="badge me-2 bg-orange">全部</span>
                    {% endif %}
                  </div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">選種規則</div>
                  <div class="datagrid-content">
                    {% if Task.rss_rule|brush_rule_string|safe %}
                      {{ Task.rss_rule|brush_rule_string|safe }}
                    {% else %}
                      無限制
                    {% endif %}
                  </div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">刪種規則</div>
                  <div class="datagrid-content">
                    {% if Task.remove_rule|brush_rule_string|safe %}
                      {{ Task.remove_rule|brush_rule_string|safe }}
                    {% else %}
                      未啟用
                    {% endif %}
                  </div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">保種體積</div>
                  <div class="datagrid-content">
                    {% if Task.seed_size %}{{ Task.seed_size }} GB{% else %}無限制{% endif %}</div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">重新整理間隔</div>
                  <div class="datagrid-content">{{ Task.interval }} 分鐘</div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">下載器</div>
                  <div class="datagrid-content">{{ Task.downloader_name or "" }}</div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">訊息推送</div>
                  <div class="datagrid-content">
                    {% if Task.sendmessage == 'Y' %}
                      <span class="status status-green">開</span>
                    {% else %}
                      <span class="status status-red">關</span>
                    {% endif %}
                  </div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">強制做種</div>
                  <div class="datagrid-content">
                    {% if Task.forceupload == 'Y' %}
                      <span class="status status-green">開</span>
                    {% else %}
                      <span class="status status-red">關</span>
                    {% endif %}
                  </div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">轉移到媒體庫</div>
                  <div class="datagrid-content">
                    {% if Task.transfer == 'Y' %}
                      <span class="status status-green">開</span>
                    {% else %}
                      <span class="status status-red">關</span>
                    {% endif %}
                  </div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">已下載種子數</div>
                  <div class="datagrid-content">{{ Task.download_count }}</div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">已刪除種子數</div>
                  <div class="datagrid-content">{{ Task.remove_count }}</div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">下載量</div>
                  <div class="datagrid-content">{{ Task.download_size }}</div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">上傳量</div>
                  <div class="datagrid-content">{{ Task.upload_size }}</div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">最後更新時間</div>
                  <div class="datagrid-content">
                    {{ Task.lst_mod_date }}
                  </div>
                </div>
                <div class="datagrid-item">
                  <div class="datagrid-title">狀態</div>
                  <div class="datagrid-content">
                    {% if Task.state == 'Y' %}
                      <span class="badge me-2 bg-green">正在執行</span>
                    {% else %}
                      <span class="badge me-2 bg-red">已停用</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% else %}
  <div class="page-body">
    <div class="container-xl d-flex flex-column justify-content-center">
      <div class="empty">
        <div class="empty-img"><img src="./static/img/quitting_time.svg" height="128" alt="">
        </div>
        <p class="empty-title">沒有記錄</p>
        <p class="empty-subtitle text-muted">
          當前沒有正在執行的刷流任務
        </p>
      </div>
    </div>
  </div>
{% endif %}
<div class="modal modal-blur fade" id="modal-brushtask" tabindex="-1" role="dialog" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="brushtask_modal_title">新建任務</h5>
        <input type="hidden" id="brushtask_id">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">任務名稱</label>
              <input type="text" id="brushtask_name" class="form-control">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">站點</label>
              <select class="form-select" id="brushtask_site">
                <option value="" selected>請選擇</option>
                {% for site in Sites %}
                  <option value="{{ site.id }}">{{ site.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">重新整理間隔(分鐘) <span class="form-help"
                                                                      title="檢查站點RSS更新的間隔時間，為了減小站點壓力，建議不小於5分鐘"
                                                                      data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="brushtask_interval" class="form-control" placeholder="10">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">下載器 <span class="form-help"
                                                              title="選擇刷流任務使用的下載器，在自定義下載器中新增，如需識別轉移到媒體庫，需與正在使用的下載器相同"
                                                              data-bs-toggle="tooltip">?</span></label>
              <select class="form-select" id="brushtask_downloader">
                <option value="" selected>請選擇</option>
                {% for downloader in Downloaders %}
                  <option value="{{ downloader.id }}">{{ downloader.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">保種體積(GB) <span class="form-help"
                                                           title="該任務所有下載任務的保種體積超過設定值時不再新增下載"
                                                           data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="brushtask_totalsize" class="form-control" placeholder="">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">狀態</label>
              <select class="form-select" id="brushtask_state">
                <option value="Y">正常</option>
                <option value="N">暫停</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="brushtask_sendmessage">
                <span class="form-check-label">訊息推送 <span class="form-help" title="開啟後會將當前任務的情況進行推送"
                                                              data-bs-toggle="tooltip">?</span></span>
              </label>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="brushtask_forceupload">
                <span class="form-check-label">強制做種 <span class="form-help"
                                                              title="開啟後當前任務的新增下載將設定為強制下載/做種狀態"
                                                              data-bs-toggle="tooltip">?</span></span>
              </label>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="brushtask_transfer">
                <span class="form-check-label">轉移到媒體庫 <span class="form-help"
                                                                  title="開啟後刷流的下載也會進行轉移並識別重新命名到媒體庫"
                                                                  data-bs-toggle="tooltip">?</span></span>
              </label>
            </div>
          </div>
        </div>
        <div class="hr-text hr-text-center hr-text-spaceless mt-1 mb-3">選種規則</div>
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">促銷 <span class="form-help"
                                                   title="選全部即不過濾會下載到非促銷的種子，免費包括2X免費"
                                                   data-bs-toggle="tooltip">?</span></label>
              <select class="form-select" id="brushtask_free">
                <option value="" selected>全部</option>
                <option value="FREE">免費</option>
                <option value="2XFREE">2X免費</option>
              </select>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">Hit&Run</label>
              <select class="form-select" id="brushtask_hr">
                <option value="" selected>全部</option>
                <option value="HR">排除HR</option>
              </select>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">同時下載任務數 <span class="form-help"
                                                             title="下載器中正在下載的任務數超過此值時不再新增下載"
                                                             data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="brushtask_dlcount" class="form-control" placeholder="10">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">包含 <span class="form-help"
                                                   title="種子名稱或副標題中包括對應關鍵字或者匹配正則式時才會下載"
                                                   data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="brushtask_include" class="form-control" placeholder="關鍵字或正規表示式">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">排除 <span class="form-help"
                                                   title="種子名稱或副標題中包括對應關鍵字或者匹配正則式時不會下載"
                                                   data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="brushtask_exclude" class="form-control" placeholder="關鍵字或正規表示式">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">上傳限速（KB/S） <span class="form-help" title="限制新增下載後的上傳速度"
                                                             data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="brushtask_upspeed" class="form-control" placeholder="">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">下載限速（KB/S） <span class="form-help" title="限制新增下載後的下載速度"
                                                             data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="brushtask_downspeed" class="form-control" placeholder="">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">種子大小(GB) <span class="form-help"
                                                           title="設定大小範圍的種子才會下載，介於時使用英文逗號,分隔兩個值"
                                                           data-bs-toggle="tooltip">?</span></label>
              <div class="input-group">
                <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" id="brushtask_torrent_size_btn">
                  全部
                </button>
                <input type="hidden" id="brushtask_torrent_size_do">
                <div class="dropdown-menu" style="">
                  <a class="dropdown-item" id="brushtask_torrent_size_do_" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('', 'brushtask_torrent_size',$(this))">
                    全部
                  </a>
                  <a class="dropdown-item" id="brushtask_torrent_size_do_gt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('gt', 'brushtask_torrent_size',$(this))">
                    大於
                  </a>
                  <a class="dropdown-item" id="brushtask_torrent_size_do_lt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('lt', 'brushtask_torrent_size',$(this))">
                    小於
                  </a>
                  <a class="dropdown-item" id="brushtask_torrent_size_do_bw" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('bw', 'brushtask_torrent_size',$(this))">
                    介於
                  </a>
                </div>
                <input type="text" class="form-control" id="brushtask_torrent_size" readonly>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">做種人數限制 <span class="form-help"
                                                           title="種子當前做種人數限制，介於時使用英文逗號,分隔兩個值，比較值時均包括邊界值本身"
                                                           data-bs-toggle="tooltip">?</span></label>
              <div class="input-group">
                <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" id="brushtask_peercount_btn">
                  全部
                </button>
                <input type="hidden" id="brushtask_peercount_do">
                <div class="dropdown-menu" style="">
                  <a class="dropdown-item" id="brushtask_peercount_do_" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('', 'brushtask_peercount',$(this))">
                    全部
                  </a>
                  <a class="dropdown-item" id="brushtask_peercount_do_gt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('gt', 'brushtask_peercount',$(this))">
                    大於
                  </a>
                  <a class="dropdown-item" id="brushtask_peercount_do_lt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('lt', 'brushtask_peercount',$(this))">
                    小於
                  </a>
                  <a class="dropdown-item" id="brushtask_peercount_do_bw" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('bw', 'brushtask_peercount',$(this))">
                    介於
                  </a>
                </div>
                <input type="text" id="brushtask_peercount" class="form-control" placeholder="" readonly/>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">釋出時間（小時） <span class="form-help"
                                                             title="種子的釋出時間在選定範圍內時才會下載"
                                                             data-bs-toggle="tooltip">?</span></label>
              <div class="input-group">
                <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" id="brushtask_pubdate_btn">
                  全部
                </button>
                <input type="hidden" id="brushtask_pubdate_do">
                <div class="dropdown-menu" style="">
                  <a class="dropdown-item" id="brushtask_pubdate_do_" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('', 'brushtask_pubdate',$(this))">
                    全部
                  </a>
                  <a class="dropdown-item" id="brushtask_pubdate_do_lt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('lt', 'brushtask_pubdate',$(this))">
                    小於
                  </a>
                </div>
                <input type="text" id="brushtask_pubdate" class="form-control" placeholder="" readonly/>
              </div>
            </div>
          </div>
        </div>
        <div class="hr-text hr-text-center hr-text-spaceless mt-1 mb-3">刪種規則</div>
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">做種時間(小時) <span class="form-help" title="做種超過設定時間時會刪除下載任務"
                                                             data-bs-toggle="tooltip">?</span></label>
              <div class="input-group">
                <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" id="brushtask_seedtime_btn">
                  忽略
                </button>
                <input type="hidden" id="brushtask_seedtime_do">
                <div class="dropdown-menu" style="">
                  <a class="dropdown-item" id="brushtask_seedtime_do_" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('', 'brushtask_seedtime',$(this))">
                    忽略
                  </a>
                  <a class="dropdown-item" id="brushtask_seedtime_do_gt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('gt', 'brushtask_seedtime',$(this))">
                    大於
                  </a>
                </div>
                <input type="text" class="form-control" id="brushtask_seedtime" readonly>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">分享率 <span class="form-help" title="分享率超過設定值時會刪除下載任務"
                                                     data-bs-toggle="tooltip">?</span></label>
              <div class="input-group">
                <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" id="brushtask_seedratio_btn">
                  忽略
                </button>
                <input type="hidden" id="brushtask_seedratio_do">
                <div class="dropdown-menu" style="">
                  <a class="dropdown-item" id="brushtask_seedratio_do_" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('', 'brushtask_seedratio',$(this))">
                    忽略
                  </a>
                  <a class="dropdown-item" id="brushtask_seedratio_do_gt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('gt', 'brushtask_seedratio',$(this))">
                    大於
                  </a>
                </div>
                <input type="text" class="form-control" id="brushtask_seedratio" readonly>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">上傳量(GB) <span class="form-help" title="上傳量超過設定值時會刪除下載任務"
                                                         data-bs-toggle="tooltip">?</span></label>
              <div class="input-group">
                <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" id="brushtask_seedsize_btn">
                  忽略
                </button>
                <input type="hidden" id="brushtask_seedsize_do">
                <div class="dropdown-menu" style="">
                  <a class="dropdown-item" id="brushtask_seedsize_do_" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('', 'brushtask_seedsize',$(this))">
                    忽略
                  </a>
                  <a class="dropdown-item" id="brushtask_seedsize_do_gt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('gt', 'brushtask_seedsize',$(this))">
                    大於
                  </a>
                </div>
                <input type="text" class="form-control" id="brushtask_seedsize" readonly>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">下載耗時(小時) <span class="form-help"
                                                             title="下載耗時超過設定值仍然未下載完成時會刪除下載任務"
                                                             data-bs-toggle="tooltip">?</span></label>
              <div class="input-group">
                <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" id="brushtask_dltime_btn">
                  忽略
                </button>
                <input type="hidden" id="brushtask_dltime_do">
                <div class="dropdown-menu" style="">
                  <a class="dropdown-item" id="brushtask_dltime_do_" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('', 'brushtask_dltime',$(this))">
                    忽略
                  </a>
                  <a class="dropdown-item" id="brushtask_dltime_do_gt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('gt', 'brushtask_dltime',$(this))">
                    大於
                  </a>
                </div>
                <input type="text" class="form-control" id="brushtask_dltime" readonly>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">平均上傳速度(KB/S) <span class="form-help"
                                                                 title="平均上傳速度低於設定值時刪除下載任務，檢查週期為10分鐘"
                                                                 data-bs-toggle="tooltip">?</span></label>
              <div class="input-group">
                <button type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false" id="brushtask_avg_upspeed_btn">
                  忽略
                </button>
                <input type="hidden" id="brushtask_avg_upspeed_do">
                <div class="dropdown-menu" style="">
                  <a class="dropdown-item" id="brushtask_avg_upspeed_do_" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('', 'brushtask_avg_upspeed',$(this))">
                    忽略
                  </a>
                  <a class="dropdown-item" id="brushtask_avg_upspeed_do_lt" href="javascript:void(0)"
                     onclick="javascript:filter_item_change('lt', 'brushtask_avg_upspeed',$(this))">
                    小於
                  </a>
                </div>
                <input type="text" class="form-control" id="brushtask_avg_upspeed" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link me-auto" data-bs-dismiss="modal">取消</button>
        <a href="javascript:add_brushtask_job()" id="brushtask_add_btn" class="btn btn-primary">確定</a>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  // 顯示新增刷流任務
  function show_brushtask_modal() {
    if (!{{ Sites|length }}) {
      show_fail_modal("沒有可用於刷流的站點，請先維護站點資訊！", function () {
        navmenu('site');
      });
      return;
    }
    $("#brushtask_modal_title").text("新建任務");
    $("#brushtask_id").val("");
    $("#modal-brushtask").modal('show');
  }

  // 摺疊任務詳情
  function show_brushtask_detail(taskid) {
    $(`#detail_${taskid}`).slideToggle();
    $(`#detail_size_${taskid}`).slideToggle();
  }

  // 顯示編輯刷流任務
  function edit_brushtask_modal(brushid) {
    $("#brushtask_id").val(brushid);
    ajax_post("brushtask_detail", {"id": brushid}, function (ret) {
      if (ret.code == 0) {
        //賦值
        $("#brushtask_modal_title").text("編輯任務");
        $("#brushtask_name").val(ret.task.name);
        $("#brushtask_site").val(ret.task.site);
        brushtask_site_change(ret.task.site, ret.task.free, ret.task.rss_rule.hr);
        $("#brushtask_interval").val(ret.task.interval);
        $("#brushtask_downloader").val(ret.task.downloader);
        $("#brushtask_totalsize").val(ret.task.seed_size);
        $("#brushtask_state").val(ret.task.state);
        if (ret.task.transfer == "Y") {
          $("#brushtask_transfer").prop("checked", true);
        } else {
          $("#brushtask_transfer").prop("checked", false);
        }
        if (ret.task.sendmessage == "Y") {
          $("#brushtask_sendmessage").prop("checked", true);
        } else {
          $("#brushtask_sendmessage").prop("checked", false);
        }
        if (ret.task.forceupload == "Y") {
          $("#brushtask_forceupload").prop("checked", true);
        } else {
          $("#brushtask_forceupload").prop("checked", false);
        }
        $("#brushtask_dlcount").val(ret.task.rss_rule.dlcount)
        $("#brushtask_peercount").val(ret.task.rss_rule.peercount)
        $("#brushtask_include").val(ret.task.rss_rule.include);
        $("#brushtask_exclude").val(ret.task.rss_rule.exclude);
        //種子大小
        if (ret.task.rss_rule.size) {
          let size_str = ret.task.rss_rule.size.split('#');
          filter_item_change(size_str[0], 'brushtask_torrent_size', $('#brushtask_torrent_size_do_' + size_str[0]), size_str[1])
        }
        //種子大小
        if (ret.task.rss_rule.peercount) {
          let peercount_str = ret.task.rss_rule.peercount;
          if (peercount_str === '') {
            peercount_str = '#';
          } else if (peercount_str.indexOf('#') === -1) {
            peercount_str = 'lt#' + peercount_str;
          }
          let peercount_strs = peercount_str.split('#');
          filter_item_change(peercount_strs[0], 'brushtask_peercount', $('#brushtask_peercount_do_' + peercount_strs[0]), peercount_strs[1])
        }
        //做種時間
        if (ret.task.remove_rule.time) {
          let seedtime_str = ret.task.remove_rule.time.split('#');
          filter_item_change(seedtime_str[0], 'brushtask_seedtime', $('#brushtask_seedtime_do_' + seedtime_str[0]), seedtime_str[1])
        }
        //做種大小
        if (ret.task.remove_rule.uploadsize) {
          let seedsize_str = ret.task.remove_rule.uploadsize.split('#');
          filter_item_change(seedsize_str[0], 'brushtask_seedsize', $('#brushtask_seedsize_do_' + seedsize_str[0]), seedsize_str[1])
        }
        //分享率
        if (ret.task.remove_rule.ratio) {
          let seedratio_str = ret.task.remove_rule.ratio.split('#');
          filter_item_change(seedratio_str[0], 'brushtask_seedratio', $('#brushtask_seedratio_do_' + seedratio_str[0]), seedratio_str[1])
        }
        //下載耗時
        if (ret.task.remove_rule.dltime) {
          let dltime_str = ret.task.remove_rule.dltime.split('#');
          filter_item_change(dltime_str[0], 'brushtask_dltime', $('#brushtask_dltime_do_' + dltime_str[0]), dltime_str[1])
        }
        //平均上傳速度
        if (ret.task.remove_rule.avg_upspeed) {
          let avg_upspeed_str = ret.task.remove_rule.avg_upspeed.split('#');
          filter_item_change(avg_upspeed_str[0], 'brushtask_avg_upspeed', $('#brushtask_avg_upspeed_do_' + avg_upspeed_str[0]), avg_upspeed_str[1])
        }
        //釋出日期
        if (ret.task.rss_rule.pubdate) {
          let pubdate_str = ret.task.rss_rule.pubdate.split('#');
          filter_item_change(pubdate_str[0], 'brushtask_pubdate', $('#brushtask_pubdate_do_' + pubdate_str[0]), pubdate_str[1])
        }
        //上傳限速
        $("#brushtask_upspeed").val(ret.task.rss_rule.upspeed);
        //下載限速
        $("#brushtask_downspeed").val(ret.task.rss_rule.downspeed);
        //彈窗
        $("#modal-brushtask").modal('show');
      }
    });
  }

  // 顯示刪除刷流任務
  function del_brushtask_modal(brushid, name) {
    show_confirm_modal("刪除刷流任務 " + name + " ？", function () {
      hide_confirm_modal();
      ajax_post("del_brushtask", {"id": brushid}, function (ret) {
        navmenu('brushtask');
      });
    });
  }

  // 選擇了站點
  function brushtask_site_change(site_id, free_value, hr_value) {
    if (!site_id) {
      return;
    }
    ajax_post("get_site", {"id": site_id}, function (ret) {
      $("#brushtask_free").empty().append('<option value="" selected>全部</option>');
      if (ret.site_free) {
        $("#brushtask_free").append('<option value="FREE">免費</option>');
      }
      if (ret.site_2xfree) {
        $("#brushtask_free").append('<option value="2XFREE">2X免費</option>');
      }
      if (free_value) {
        $("#brushtask_free").val(free_value);
      }
      $("#brushtask_hr").empty().append('<option value="" selected>全部</option>');
      if (ret.site_hr) {
        $("#brushtask_hr").append('<option value="HR">排除HR</option>');
      }
      if (hr_value) {
        $("#brushtask_hr").val(hr_value);
      }
    });
  }

  // 範圍條件
  function filter_item_change(type, id, item, value) {
    let input_obj = $("#" + id);
    let button_obj = $("#" + id + "_btn");
    let do_obj = $("#" + id + "_do");
    if (!type) {
      input_obj.val("");
      do_obj.val("");
      input_obj.attr("readonly", "readonly");
    } else {
      input_obj.removeAttr("readonly");
      do_obj.val(type);
    }
    button_obj.text(item.text());
    if (value) {
      input_obj.val(value);
    }
  }

  // 新增任務儲存
  function add_brushtask_job() {
    // 檢查輸入項
    let brushtask_id = $("#brushtask_id").val();
    let brushtask_name = $("#brushtask_name").val();
    if (!brushtask_name) {
      $("#brushtask_name").addClass("is-invalid");
      return;
    } else {
      $("#brushtask_name").removeClass("is-invalid");
    }
    let brushtask_site = $("#brushtask_site").val();
    if (!brushtask_site) {
      $("#brushtask_site").addClass("is-invalid");
      return;
    } else {
      $("#brushtask_site").removeClass("is-invalid");
    }
    let brushtask_interval = $("#brushtask_interval").val();
    if (!brushtask_interval || isNaN(brushtask_interval)) {
      $("#brushtask_interval").addClass("is-invalid");
      return;
    } else {
      $("#brushtask_interval").removeClass("is-invalid");
    }
    let brushtask_downloader = $("#brushtask_downloader").val();
    if (!brushtask_downloader) {
      $("#brushtask_downloader").addClass("is-invalid");
      return;
    } else {
      $("#brushtask_downloader").removeClass("is-invalid");
    }
    let brushtask_totalsize = $("#brushtask_totalsize").val();
    if (brushtask_totalsize && isNaN(brushtask_totalsize)) {
      $("#brushtask_totalsize").addClass("is-invalid");
      return;
    }
    let brushtask_state = $("#brushtask_state").val();
    let brushtask_transfer = $("#brushtask_transfer").prop('checked');
    let brushtask_sendmessage = $("#brushtask_sendmessage").prop('checked');
    let brushtask_forceupload = $("#brushtask_forceupload").prop('checked');
    let brushtask_free = $("#brushtask_free").val();
    let brushtask_hr = $("#brushtask_hr").val();
    //種子大小
    let brushtask_torrent_size_do = $("#brushtask_torrent_size_do").val();
    let brushtask_torrent_size = $("#brushtask_torrent_size").val();
    if (brushtask_torrent_size_do && !brushtask_torrent_size) {
      $("#brushtask_torrent_size").addClass("is-invalid");
      return;
    } else {
      if (brushtask_torrent_size && brushtask_torrent_size_do != 'bw' && isNaN(brushtask_torrent_size)) {
        $("#brushtask_torrent_size").addClass("is-invalid");
        return;
      } else if (brushtask_torrent_size && brushtask_torrent_size_do == 'bw' && !/\d+,\d+/.test(brushtask_torrent_size)) {
        $("#brushtask_torrent_size").addClass("is-invalid");
        return;
      }
      $("#brushtask_torrent_size").removeClass("is-invalid");
    }
    //包含
    let brushtask_include = $("#brushtask_include").val();
    //排除
    let brushtask_exclude = $("#brushtask_exclude").val();
    //同時下載數
    let brushtask_dlcount = $("#brushtask_dlcount").val();
    if (brushtask_dlcount && isNaN(brushtask_dlcount)) {
      $("#brushtask_dlcount").addClass("is-invalid");
      return;
    } else {
      $("#brushtask_dlcount").removeClass("is-invalid");
    }
    //上傳限速
    let brushtask_upspeed = $("#brushtask_upspeed").val();
    if (brushtask_upspeed && isNaN(brushtask_upspeed)) {
      $("#brushtask_upspeed").addClass("is-invalid");
      return;
    } else {
      $("#brushtask_upspeed").removeClass("is-invalid");
    }
    //下載限速
    let brushtask_downspeed = $("#brushtask_downspeed").val();
    if (brushtask_downspeed && isNaN(brushtask_downspeed)) {
      $("#brushtask_downspeed").addClass("is-invalid");
      return;
    } else {
      $("#brushtask_downspeed").removeClass("is-invalid");
    }
    //釋出時間
    let brushtask_pubdate_do = $("#brushtask_pubdate_do").val();
    let brushtask_pubdate = $("#brushtask_pubdate").val();
    if (brushtask_pubdate_do && !brushtask_pubdate) {
      $("#brushtask_pubdate").addClass("is-invalid");
      return;
    } else {
      if (brushtask_pubdate && brushtask_pubdate_do != 'bw' && isNaN(brushtask_pubdate)) {
        $("#brushtask_pubdate").addClass("is-invalid");
        return;
      } else if (brushtask_pubdate && brushtask_pubdate_do == 'bw' && !/\d+,\d+/.test(brushtask_pubdate)) {
        $("#brushtask_pubdate").addClass("is-invalid");
        return;
      }
      $("#brushtask_pubdate").removeClass("is-invalid");
    }
    //做種人數
    let brushtask_peercount_do = $("#brushtask_peercount_do").val();
    let brushtask_peercount = $("#brushtask_peercount").val();
    if (brushtask_peercount_do && !brushtask_peercount) {
      $("#brushtask_peercount").addClass("is-invalid");
      return;
    } else {
      if (brushtask_peercount && brushtask_peercount_do != 'bw' && isNaN(brushtask_peercount)) {
        $("#brushtask_peercount").addClass("is-invalid");
        return;
      } else if (brushtask_peercount && brushtask_peercount_do == 'bw' && !/\d+,\d+/.test(brushtask_peercount)) {
        $("#brushtask_peercount").addClass("is-invalid");
        return;
      }
      $("#brushtask_peercount").removeClass("is-invalid");
    }
    //做種時間
    let brushtask_seedtime_do = $("#brushtask_seedtime_do").val();
    let brushtask_seedtime = $("#brushtask_seedtime").val();
    if (brushtask_seedtime_do && !brushtask_seedtime) {
      $("#brushtask_seedtime").addClass("is-invalid");
      return;
    } else {
      if (brushtask_seedtime && isNaN(brushtask_seedtime)) {
        $("#brushtask_seedtime").addClass("is-invalid");
        return;
      }
      $("#brushtask_seedtime").removeClass("is-invalid");
    }
    //分享率
    let brushtask_seedratio_do = $("#brushtask_seedratio_do").val();
    let brushtask_seedratio = $("#brushtask_seedratio").val();
    if (brushtask_seedratio_do && !brushtask_seedratio) {
      $("#brushtask_seedratio").addClass("is-invalid");
      return;
    } else {
      if (brushtask_seedratio && isNaN(brushtask_seedratio)) {
        $("#brushtask_seedratio").addClass("is-invalid");
        return;
      }
      $("#brushtask_seedratio").removeClass("is-invalid");
    }
    //上傳量
    let brushtask_seedsize_do = $("#brushtask_seedsize_do").val();
    let brushtask_seedsize = $("#brushtask_seedsize").val();
    if (brushtask_seedsize_do && !brushtask_seedsize) {
      $("#brushtask_seedsize").addClass("is-invalid");
      return;
    } else {
      if (brushtask_seedsize && isNaN(brushtask_seedsize)) {
        $("#brushtask_seedsize").addClass("is-invalid");
        return;
      }
      $("#brushtask_seedsize").removeClass("is-invalid");
    }
    //下載耗時
    let brushtask_dltime_do = $("#brushtask_dltime_do").val();
    let brushtask_dltime = $("#brushtask_dltime").val();
    if (brushtask_dltime_do && !brushtask_dltime) {
      $("#brushtask_dltime").addClass("is-invalid");
      return;
    } else {
      if (brushtask_dltime && isNaN(brushtask_dltime)) {
        $("#brushtask_dltime").addClass("is-invalid");
        return;
      }
      $("#brushtask_dltime").removeClass("is-invalid");
    }
    //平均上傳速度
    let brushtask_avg_upspeed_do = $("#brushtask_avg_upspeed_do").val();
    let brushtask_avg_upspeed = $("#brushtask_avg_upspeed").val();
    if (brushtask_avg_upspeed_do && !brushtask_avg_upspeed) {
      $("#brushtask_avg_upspeed").addClass("is-invalid");
      return;
    } else {
      if (brushtask_avg_upspeed && isNaN(brushtask_avg_upspeed)) {
        $("#brushtask_avg_upspeed").addClass("is-invalid");
        return;
      }
      $("#brushtask_avg_upspeed").removeClass("is-invalid");
    }

    // 引數
    const params = {
      brushtask_id: brushtask_id,
      brushtask_name: brushtask_name,
      brushtask_site: brushtask_site,
      brushtask_interval: brushtask_interval,
      brushtask_downloader: brushtask_downloader,
      brushtask_totalsize: brushtask_totalsize,
      brushtask_state: brushtask_state,
      brushtask_transfer: brushtask_transfer,
      brushtask_sendmessage: brushtask_sendmessage,
      brushtask_forceupload: brushtask_forceupload,
      brushtask_free: brushtask_free,
      brushtask_hr: brushtask_hr,
      brushtask_torrent_size: brushtask_torrent_size_do + "#" + brushtask_torrent_size,
      brushtask_include: brushtask_include,
      brushtask_exclude: brushtask_exclude,
      brushtask_dlcount: brushtask_dlcount,
      brushtask_peercount: brushtask_peercount_do + "#" + brushtask_peercount,
      brushtask_seedtime: brushtask_seedtime_do + "#" + brushtask_seedtime,
      brushtask_seedratio: brushtask_seedratio_do + "#" + brushtask_seedratio,
      brushtask_seedsize: brushtask_seedsize_do + "#" + brushtask_seedsize,
      brushtask_dltime: brushtask_dltime_do + "#" + brushtask_dltime,
      brushtask_avg_upspeed: brushtask_avg_upspeed_do + "#" + brushtask_avg_upspeed,
      brushtask_upspeed: brushtask_upspeed,
      brushtask_downspeed: brushtask_downspeed,
      brushtask_pubdate: brushtask_pubdate_do + "#" + brushtask_pubdate
    };

    ajax_post("add_brushtask", params, function (ret) {
      $("#modal-brushtask").modal('hide');
      navmenu('brushtask');
    });
  }

  // 繫結事件
  $(document).ready(function () {
    $("#brushtask_site").change(function () {
      brushtask_site_change($(this).val());
    });
  });

  //立即執行任務
  function run_brushtask_now(id) {
    show_wait_process();
    ajax_post("run_brushtask", {"id": id}, function (ret) {
      hide_wait_process();
      show_success_modal("任務執行完成！", function () {
        navmenu('brushtask');
      });
    });
  }

</script>