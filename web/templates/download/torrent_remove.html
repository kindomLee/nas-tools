<div class="container-xl">
  <!-- Page title -->
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">
          自動刪種任務
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="javascript:show_add_torrent_remove_task_modal()" class="btn btn-primary d-none d-sm-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            新增刪種任務
          </a>
          <a href="javascript:show_add_torrent_remove_task_modal()" class="btn btn-primary d-sm-none btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 業務頁面程式碼 -->
{% if Count > 0 %}
<div class="page-body">
  <div class="container-xl">
    <div class="row row-cards">
      {% for Id, Attr in TorrentRemoveTasks.items() %}
      <div class="card">
        <div class="card-header">
          {% if Attr.enabled %}
          <span class="badge bg-green"></span>
          {% else %}
          <span class="badge bg-red"></span>
          {% endif %}
          <div class="ms-2"><h3 class="card-title">{{ Attr.name }}</h3></div>
          <div class="ms-2">
            <a href="javascript:run_torrent_remove_now('{{ Attr.id }}')" class="btn-icon" title="立即執行任務"
              data-bs-toggle="tooltip">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-bolt icon-filled" width="24"
                height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <polyline points="13 3 13 10 19 10 11 21 11 14 5 14 13 3"></polyline>
              </svg>
            </a>
          </div>
          <div class="card-actions btn-actions">
            <a href="javascript:show_torrent_remove_task_detail('{{ Attr.id }}')" class="btn-action">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="20" height="20" fill="currentColor"
                viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                  d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z" />
              </svg>
            </a>
            <a href="javascript:show_remove_torrents_modal('{{ Attr.id }}')" class="btn-action">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-eye" width="24" height="24"
                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <circle cx="12" cy="12" r="2"></circle>
                <path d="M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7">
                </path>
              </svg>
            </a>
            <a href="javascript:show_edit_torrent_remove_task_modal('{{ Attr.id }}')" class="btn-action" title="編輯設定">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon ms-1" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M9 7h-3a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-3" />
                <path d="M9 15h3l8.5 -8.5a1.5 1.5 0 0 0 -3 -3l-8.5 8.5v3" />
                <line x1="16" y1="5" x2="19" y2="8" />
              </svg>
            </a>
            <a href="javascript:delete_torrent_remove_task('{{ Attr.id }}', '{{ Attr.name }}')" class="btn-action" title="刪除設定">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <desc>Download more icon variants from https://tabler-icons.io/i/x</desc>
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </a>
          </div>
        </div>
        <div class="card-body" id="detail_{{ Attr.id }}"
            style="display: {% if Count > 3 %}none{% else %}block{% endif %};">
          <div class="datagrid">
            <div class="datagrid-item">
              <div class="datagrid-title">下載器</div>
              <div class="datagrid-content">
                <span class="badge me-2 bg-blue">{{ DownloaderConfig[Attr.downloader].name}}</span>
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">管理限制</div>
              <div class="datagrid-content">
              {% if Attr.onlynastool %}
                <span class="badge me-2">只管理NAStool新增</span>
              {% endif %}
              {% if Attr.samedata %}
                <span class="badge me-2">處理輔種</span>
              {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">重新整理間隔</div>
              <div class="datagrid-content">
                {{ Attr.interval }} 分鐘
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">動作</div>
              <div class="datagrid-content">
                {% if Attr.action == 1 %}
                <span class="badge me-2 bg-blue">暫停任務</span>
                {% elif Attr.action == 2 %}
                <span class="badge me-2 bg-orange">刪除任務</span>
                {% elif Attr.action == 3 %}
                <span class="badge me-2 bg-red">刪除任務及檔案</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">分享率</div>
              <div class="datagrid-content">
              {% if Attr.config.ratio %}
                {{ Attr.config.ratio }} +
              {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">做種時間</div>
              <div class="datagrid-content">
              {% if Attr.config.seeding_time %}
                {{ Attr.config.seeding_time }} 小時 +
              {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">平均做種速度</div>
              <div class="datagrid-content">
              {% if Attr.config.upload_avs %}
                {{ Attr.config.upload_avs }} KB/s -
              {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">大小</div>
              <div class="datagrid-content">
              {% if Attr.config.size %}
                {{ Attr.config.size[0] }}-{{ Attr.config.size[-1] }} GB
              {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">儲存路徑關鍵詞</div>
              <div class="datagrid-content">
              {% if Attr.config.savepath_key %}
                <span class="badge me-2 bg-orange">{{ Attr.config.savepath_key }}</span>
              {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">tracker關鍵詞</div>
              <div class="datagrid-content">
              {% if Attr.config.tracker_key %}
                <span class="badge me-2 bg-orange">{{ Attr.config.tracker_key }}</span>
              {% endif %}
              </div>
            </div>
            {% if Attr.downloader == "Qb" %}
              <div class="datagrid-item">
                <div class="datagrid-title">分類</div>
                <div class="datagrid-content">
                  {% if Attr.config.qb_category %}
                  {% for Category in Attr.config.qb_category %}
                  <span class="badge me-2 mb-1">{{ Category }}</span>
                  {% endfor %}
                  {% endif %}
                </div>
              </div>
              <div class="datagrid-item">
                <div class="datagrid-title">種子狀態</div>
                <div class="datagrid-content">
                  {% if Attr.config.qb_state %}
                  {% for State in Attr.config.qb_state %}
                  <span class="badge me-2 bg-blue mb-1">{{ State }}</span>
                  {% endfor %}
                  {% endif %}
                </div>
              </div>
            {% elif Attr.downloader == "Tr" %}
              <div class="datagrid-item">
                <div class="datagrid-title">錯誤資訊關鍵詞</div>
                <div class="datagrid-content">
                {% if Attr.config.tr_error_key %}
                  <span class="badge me-2 bg-orange">{{ Attr.config.tr_error_key }}</span>
                {% endif %}
                </div>
              </div>
              <div class="datagrid-item">
                <div class="datagrid-title">種子狀態</div>
                <div class="datagrid-content">
                  {% if Attr.config.tr_state %}
                  {% for State in Attr.config.tr_state %}
                  <span class="badge me-2 bg-blue mb-1">{{ State }}</span>
                  {% endfor %}
                  {% endif %}
                </div>
              </div>
            {% endif %}
            <div class="datagrid-item">
              <div class="datagrid-title">狀態</div>
              <div class="datagrid-content">
                {% if Attr.enabled %}
                <span class="badge me-2 bg-green">正在執行</span>
                {% else %}
                <span class="badge me-2 bg-red">已停用</span>
                {% endif %}
              </div>
            </div>
            <div class="datagrid-item">
              <div class="datagrid-title">標籤</div>
              <div class="datagrid-content">
                {% if Attr.config.tags %}
                {% for Tag in Attr.config.tags %}
                <span class="badge me-2 mb-1">{{ Tag }}</span>
                {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% else %}
<div class="page-body">
  <div class="container-xl d-flex flex-column justify-content-center">
    <div class="empty">
      <div class="empty-img"><img src="./static/img/quitting_time.svg" height="128" alt="">
      </div>
      <p class="empty-title">沒有記錄</p>
      <p class="empty-subtitle text-muted">
        當前沒有正在執行的自動刪種任務
      </p>
    </div>
  </div>
</div>
{% endif %}
<div class="modal modal-blur fade" id="modal-torrent-remove-task" tabindex="-1" role="dialog" aria-hidden="true"
  data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-torrent-remove-task-title">新增刪種任務</h5>
        <input type="hidden" id="torrent_remove_task_id" />
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">名稱</label>
              <input type="text" id="name" class="form-control" placeholder="別名">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">動作</label>
              <select class="form-select" id="action">
                <option value="1" selected>暫停種子</option>
                <option value="2">刪除種子</option>
                <option value="3">刪除種子及檔案</option>
              </select>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label required">執行間隔 <span class="form-help" title="執行自動刪種任務的間隔時間"
                  data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="interval" class="form-control" placeholder="分鐘">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">狀態</label>
              <select class="form-select" id="enabled">
                <option value="1">啟用</option>
                <option value="0" selected>停用</option>
              </select>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">處理輔種 <span class="form-help" title="若種子名稱及大小與滿足其他刪種條件的種子相同，則一併處理"
                  data-bs-toggle="tooltip">?</span></label>
              <select class="form-select" id="samedata">
                <option value="0" selected>否</option>
                <option value="1" >是</option>
              </select>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">只管理NAStool新增的下載 <span class="form-help" title="只管理含有NASTOOL標籤的種子"
                  data-bs-toggle="tooltip">?</span></label>
              <select class="form-select" id="onlynastool">
                <option value="0">否</option>
                <option value="1" selected>是</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">分享率 <span class="form-help" title="種子分享率大於等於設定值視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="ratio" class="form-control" placeholder="保留一位小數">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">做種時間 <span class="form-help" title="種子做種時間大於等於設定值視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="seeding_time" class="form-control" placeholder="小時">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="mb-3">
              <label class="form-label">平均上傳速度 <span class="form-help" title="種子平均上傳速度小於等於設定值視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="upload_avs" class="form-control" placeholder="KB/s">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-3">
            <div class="mb-3">
              <label class="form-label">種子大小 <span class="form-help" title="種子大小在設定範圍內視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="size" class="form-control" placeholder="GB，例如如1-10">
            </div>
          </div>
          <div class="col-lg-9">
            <div class="mb-3">
              <label class="form-label">標籤 <span class="form-help" title="設定多個標籤時，種子包含所有標籤視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="tags" class="form-control" placeholder="多個標籤用;分隔">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-6">
            <div class="mb-3">
              <label class="form-label">儲存路徑關鍵詞 <span class="form-help" title="種子儲存路徑含有關鍵詞視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="savepath_key" class="form-control" placeholder="支援正規表示式">
            </div>
          </div>
          <div class="col-lg-6">
            <div class="mb-3">
              <label class="form-label">tracker關鍵詞 <span class="form-help" title="種子第一個活動tracker含有關鍵詞視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="tracker_key" class="form-control" placeholder="支援正規表示式">
            </div>
          </div>
        </div>
        <div class="form-selectgroup-boxes row mb-3">
          <label class="form-label required">下載器</label>
          {% for Id, Attr in DownloaderConfig.items() %}
          <div class="col-lg-6">
            <div class="mb-1">
              <label class="form-selectgroup-item" for="downloader_{{ Id }}">
                <input type="radio" name="downloader" id="downloader_{{ Id }}" value="{{ Id }}" class="form-selectgroup-input" checked>
                <span class="form-selectgroup-label d-flex align-items-center p-3">
                  <span class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </span>
                  <span class="form-selectgroup-label-content">
                    <span class="avatar avatar-sm avatar-thumb avatar-rounded"
                          style="background-image: url({{ Attr.img_url }})"></span>
                    <span class="form-selectgroup-title strong mb-1">&nbsp;&nbsp;&nbsp;{{ Attr.name }}</span>
                  </span>
                </span>
              </label>
            </div>
          </div>
          {% endfor %}
        </div>
        <div id="qb_config_div" class="row">
          <div class="col-lg-7">
            <div class="mb-3">
              <label class="form-label">種子狀態 <span class="form-help"
                title=
                "{% for Id, Attr in DownloaderConfig.Qb.torrent_state.items() %}
                {{ Id }}：{{ Attr }}<br>
                {% endfor %}
                <br>設定多個狀態時，種子屬於其中任一狀態視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip"
                data-bs-html="true">?</span></label>
              <input type="text" id="qb_state" class="form-control" placeholder="多個狀態用;分隔">
            </div>
          </div>
          <div class="col-lg-5">
            <div class="mb-3">
              <label class="form-label">分類 <span class="form-help" title="設定多個分類時，種子屬於其中任一分類視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="qb_category" class="form-control" placeholder="多個分類用;分隔">
            </div>
          </div>
        </div>
        <div id="tr_config_div" class="row">
          <div class="col-lg-7">
            <div class="mb-3">
              <label class="form-label">種子狀態 <span class="form-help"
                title="{% for Id, Attr in DownloaderConfig.Tr.torrent_state.items() %}
                {{ Id }}：{{ Attr }}<br>
                {% endfor %}
                <br>設定多個狀態時，種子屬於其中任一狀態視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip"
                data-bs-html="true">?</span></label>
              <input type="text" id="tr_state" class="form-control" placeholder="多個狀態用;分隔">
            </div>
          </div>
          <div class="col-lg-5">
            <div class="mb-3">
              <label class="form-label">錯誤資訊關鍵詞 <span class="form-help" title="種子錯誤資訊含有關鍵詞視為滿足該條件，留空為不啟用"
                data-bs-toggle="tooltip">?</span></label>
              <input type="text" id="tr_error_key" class="form-control" placeholder="支援正規表示式">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="download_setting_close_btn" class="btn btn-link" data-bs-dismiss="modal">
          取消
        </button>
        <button id="add_or_edit_torrent_remove_task_btn" class="btn btn-primary ms-auto"
          onclick="add_or_edit_torrent_remove_task()">
          儲存
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal modal-blur fade" id="modal-remove-torrents" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">預處理種子列表</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="table-responsive" style="overflow-y: auto; max-height: 35em;">
        <table id="table-remove-torrents" class="table table-vcenter card-table">
        </table>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  // 摺疊任務詳情
  function show_torrent_remove_task_detail(tid) {
    $(`#detail_${tid}`).slideToggle();
  }

  // 顯示新增任務
  function show_add_torrent_remove_task_modal(){
    $("#torrent_remove_task_id").val('');
    $("#modal-torrent-remove-task-title").val('新增刪種任務');
    $("#name").val('');
    $("#action").val('1');
    $("#interval").val('');
    $("#enabled").val('0');
    $("#samedata").val('0');
    $("#onlynastool").val('1');
    $("#size").val('');
    $("#ratio").val('');
    $("#seeding_time").val('');
    $("#upload_avs").val('');
    $("#tags").val('');
    $("#savepath_key").val('');
    $("#tracker_key").val('');
    show_downloader("Qb");
    $("#qb_category").val('');
    $("#qb_state").val('');
    $("#tr_error_key").val('');
    $("#tr_state").val('');
    $("#modal-torrent-remove-task").modal('show');
  }

  // 顯示編輯任務
  function show_edit_torrent_remove_task_modal(tid){
    $("#torrent_remove_task_id").val(tid);
    ajax_post("get_torrent_remove_task", { tid: tid }, function (ret) {
      if (ret.code == 0) {
        $("#modal-download-setting-title").val('編輯下載設定');
        $("#name").val(ret.detail.name);
        $("#action").val(ret.detail.action);
        $("#interval").val(ret.detail.interval);
        $("#enabled").val(ret.detail.enabled);
        $("#samedata").val(ret.detail.samedata);
        $("#onlynastool").val(ret.detail.onlynastool);
        if (ret.detail.config.size.length) {
          let minsize = ret.detail.config.size[0];
          let maxsize = ret.detail.config.size[1];
          $("#size").val(`${minsize}-${maxsize}`);
        } else {
          $("#size").val('');
        }
        if (ret.detail.config.ratio) {
          $("#ratio").val(ret.detail.config.ratio);
        } else {
          $("#ratio").val('');
        }
        if (ret.detail.config.seeding_time) {
          $("#seeding_time").val(ret.detail.config.seeding_time);
        } else {
          $("#seeding_time").val('');
        }
        if (ret.detail.config.upload_avs) {
          $("#upload_avs").val(ret.detail.config.upload_avs);
        } else {
          $("#upload_avs").val('');
        }
        $("#tags").val(ret.detail.config.tags.join(';'));
        $("#savepath_key").val(ret.detail.config.savepath_key);
        $("#tracker_key").val(ret.detail.config.tracker_key);
        show_downloader(ret.detail.downloader);
        if (ret.detail.downloader == "Qb") {
          $("#qb_category").val(ret.detail.config.qb_category.join(';'));
          $("#qb_state").val(ret.detail.config.qb_state.join(';'));
          $("#tr_error_key").val('');
          $("#tr_state").val('');
        } else if (ret.detail.downloader == "Tr") {
          $("#qb_category").val('');
          $("#qb_state").val('');
          $("#tr_error_key").val(ret.detail.config.tr_error_key);
          $("#tr_state").val(ret.detail.config.tr_state.join(';'));
        }
        $("#modal-torrent-remove-task").modal('show');
      }
    });
  }

  // 儲存新建/編輯任務
  function add_or_edit_torrent_remove_task(){
    let tid = $("#torrent_remove_task_id").val();
    let name = $("#name").val();
    if (!name) {
      $("#name").addClass("is-invalid");
      return;
    } else {
      $("#name").removeClass("is-invalid");
    }
    let interval = $("#interval").val();
    if (!interval || isNaN(interval)) {
      $("#interval").addClass("is-invalid");
      return;
    } else {
      $("#interval").removeClass("is-invalid");
    }
    let ratio = $("#ratio").val();
    if (ratio && isNaN(ratio)) {
      $("#ratio").addClass("is-invalid");
      return;
    } else {
      $("#ratio").removeClass("is-invalid");
    }
    let seeding_time = $("#seeding_time").val();
    if (seeding_time && isNaN(seeding_time)) {
      $("#seeding_time").addClass("is-invalid");
      return;
    } else {
      $("#seeding_time").removeClass("is-invalid");
    }
    let upload_avs = $("#upload_avs").val();
    if (upload_avs && isNaN(upload_avs)) {
      $("#upload_avs").addClass("is-invalid");
      return;
    } else {
      $("#upload_avs").removeClass("is-invalid");
    }
    let params = {
      tid: tid,
      name: name,
      action: $("#action").val(),
      interval: interval,
      enabled: $("#enabled").val(),
      samedata: $("#samedata").val(),
      onlynastool: $("#onlynastool").val(),
      ratio: ratio,
      seeding_time: seeding_time,
      upload_avs: upload_avs,
      size: $("#size").val(),
      tags: $("#tags").val(),
      savepath_key: $("#savepath_key").val(),
      tracker_key: $("#tracker_key").val(),
      downloader: $('input:radio[name=downloader]:checked').val(),
      qb_state: $("#qb_state").val(),
      qb_category: $("#qb_category").val(),
      tr_state: $("#tr_state").val(),
      tr_error_key: $("#tr_error_key").val(),
    };
    $("#add_or_edit_torrent_remove_task_btn").text("儲存中").attr("disabled", true);
    ajax_post("update_torrent_remove_task", params, function (ret) {
      $("#modal-torrent-remove-task").modal('hide');
      if (ret.code == 0) {
        $("#add_or_edit_torrent_remove_task_btn").text("儲存").attr("disabled", false);
        navmenu('torrent_remove');
      } else {
        show_fail_modal(ret.msg, function () {
          $("#modal-torrent-remove-task").modal('show');
          $("#add_or_edit_torrent_remove_task_btn").text("儲存").attr("disabled", false);
        });
      }
    });
  }

  // 刪除任務
  function delete_torrent_remove_task(tid, name){
    show_confirm_modal("刪除下載設定 " + name + " ？", function () {
      hide_confirm_modal();
      ajax_post("delete_torrent_remove_task", { "tid": tid }, function (ret) {
        navmenu('torrent_remove');
      });
    });
  }

  // 顯示滿足條件種子
  function show_remove_torrents_modal(tid){
    show_wait_process();
    ajax_post("get_remove_torrents", { "tid": tid }, function (ret) {
      hide_wait_process();
      if (ret.code == 0) {
        let torrents = ret.data;
        let thead = `<thead><tr><th>共${torrents.length}個種子</th></tr></thead>`;
        let tbody = '';
        for (let torrent of torrents) {
          let tb = `<tr><td><span>${torrent.name}</span>
                    <br><span class="badge badge-outline text-blue me-1 mb-1">${torrent.site}</span>
                    <span class="badge badge-outline text-orange me-1 mb-1">${(torrent.size/1024/1024/1024).toFixed(2)} GB</span></td></tr>`;
          tbody = `${tbody}${tb}`;
        }
        tbody = `<tbody>${tbody}</tbody>`;
        $("#table-remove-torrents").empty().append(`${thead}${tbody}`);
        $("#modal-remove-torrents").modal('show');
      } else {
        let content = `<div class="empty"><p class="empty-title">${ret.msg}</p></div>`;
        $("#table-remove-torrents").empty().append(content);
        $("#modal-remove-torrents").modal('show');
      }
    });
  }

  // 單選框事件
  $('input[type=radio][name=downloader]').change(function () {
     let use = this.value;
    show_downloader(use);
  });

  // 刪種任務下載器
  function show_downloader(downloader) {
    if (downloader == 'Qb') {
      $("#qb_config_div").show();
      $("#tr_config_div").hide();
      $("#downloader_Qb").prop("checked", true);
    }
    else if (downloader == 'Tr') {
      $("#qb_config_div").hide();
      $("#tr_config_div").show();
      $("#downloader_Tr").prop("checked", true);
    }
  }

  // 立即執行任務
  function run_torrent_remove_now(tid) {
    show_wait_process();
    ajax_post("auto_remove_torrents", { "tid": tid }, function (ret) {
      hide_wait_process();
      show_success_modal("任務執行完成！", function () {
        navmenu('torrent_remove');
      });
    });
  }
</script>